<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Báº£n Ä‘á»“ sá»‘ PhÃº Quá»‘c â€” Dá»± Ã¡n KHKT: Tá»± hÃ o quÃª hÆ°Æ¡ng</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
  :root{
    --accent:#C62828; /* Ä‘á» */
    --gold:#FFD54F;
    --bg:#FBFBFB;
  }
  body{font-family: "Noto Sans", system-ui, sans-serif; background:var(--bg); color:#111;}
  .container-main{max-width:1100px;margin:auto;}
  .logo{width:60px;height:60px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#B71C1C);display:flex;align-items:center;justify-content:center;color:white;font-weight:800;font-size:22px}
  .hero{background:linear-gradient(90deg, rgba(198,40,40,0.06), rgba(255,213,79,0.02));padding:22px;border-radius:12px;margin:18px 0}
  .btn-accent{background:linear-gradient(90deg,var(--accent),#EF5350);color:white;border:none}
  #map{height:64vh;border-radius:12px}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px}
  .diatic-title{font-weight:700}
  .game-card{border-radius:10px;background:white;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  footer{padding:18px 0;color:#666;text-align:center;margin-top:18px}
  .correct{color:green;font-weight:700}
  .wrong{color:#c62828;font-weight:700}
  .explain{font-size:0.95rem;color:#444}
  
  /* CSS cho game ghÃ©p hÃ¬nh */
  .puzzle-container {
    text-align: center;
    padding: 20px;
  }
  
  .puzzle-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 20px;
  }
  
  .puzzle-area {
    display: flex;
    flex-direction: column;
    gap: 20px;
    align-items: center;
  }
  
  .puzzle-pieces {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
    max-width: 600px;
  }
  
  .puzzle-piece {
    width: 80px;
    height: 80px;
    border: 2px solid #ddd;
    border-radius: 8px;
    cursor: grab;
    transition: transform 0.2s;
    background-size: 400% 300%; /* Cho 4x3 grid */
    background-repeat: no-repeat;
  }
  
  .puzzle-piece:hover {
    transform: scale(1.05);
    border-color: var(--accent);
  }
  
  .puzzle-board {
    width: 320px;
    height: 240px;
    border: 3px dashed #ccc;
    border-radius: 12px;
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 2px;
    background-color: #f8f9fa;
    padding: 5px;
  }
  
  .puzzle-slot {
    border: 1px solid #eee;
    border-radius: 4px;
    transition: background-color 0.3s;
  }
  
  .puzzle-slot.hover {
    background-color: #e3f2fd;
  }
  
  .puzzle-slot.filled {
    border: 2px solid #4CAF50;
  }
  
  .puzzle-info {
    margin-top: 20px;
    padding: 15px;
    background: linear-gradient(135deg, #f5f5f5, #e8e8e8);
    border-radius: 10px;
    border-left: 4px solid var(--accent);
    display: none;
  }
  
  .puzzle-info.show {
    display: block;
    animation: fadeIn 0.5s ease;
  }
  
  .puzzle-complete {
    text-align: center;
    padding: 20px;
    background: linear-gradient(135deg, #E8F5E8, #C8E6C9);
    border-radius: 10px;
    margin-top: 20px;
    display: none;
  }
  
  .puzzle-complete.show {
    display: block;
    animation: popIn 0.5s ease;
  }

  /* Hiá»‡u á»©ng láº¯c khi sai */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }

  /* Hiá»‡u á»©ng huy hiá»‡u lá»›n */
  .badge-popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    animation: fadeIn 0.3s ease;
  }

  .badge-popup-content {
    background: white;
    border-radius: 20px;
    padding: 30px;
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    animation: popIn 0.5s ease;
    max-width: 300px;
    width: 90%;
  }

  .badge-popup-img {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    object-fit: cover;
    margin: 0 auto 15px;
    border: 4px solid var(--gold);
    animation: bounce 1s ease infinite;
  }

  .badge-popup-title {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--accent);
    margin-bottom: 10px;
  }

  .badge-popup-message {
    color: #666;
    margin-bottom: 20px;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  @keyframes popIn {
    0% { transform: scale(0.5); opacity: 0; }
    70% { transform: scale(1.1); }
    100% { transform: scale(1); opacity: 1; }
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* small responsive tweaks */
  @media (max-width:767px){ 
    .hero{padding:14px} 
    .badge-popup-content {
      padding: 20px;
    }
    .badge-popup-img {
      width: 100px;
      height: 100px;
    }
    .puzzle-piece {
      width: 60px;
      height: 60px;
    }
    .puzzle-board {
      width: 240px;
      height: 180px;
    }
  }
</style>
</head>
<body>
<div class="container container-main py-3">
  <!-- NAV / header -->
  <div class="d-flex align-items-center justify-content-between mb-2">
    <div class="d-flex gap-3 align-items-center">
      <div class="logo">PQ</div>
      <div>
        <div style="font-weight:800;font-size:1.15rem">Báº£n Ä‘á»“ sá»‘ PhÃº Quá»‘c</div>
        <div style="color:#666;font-size:0.9rem">Dá»± Ã¡n KHKT â€” GiÃ¡o dá»¥c lÃ²ng tá»± hÃ o dÃ¢n tá»™c (THPT An Thá»›i)</div>
      </div>
    </div>
    <div>
      <button id="nav-home" class="btn btn-sm btn-outline-secondary me-1">Trang chá»§</button>
      <button id="nav-map" class="btn btn-sm btn-accent">Báº£n Ä‘á»“ sá»‘</button>
      <button id="btn-profile" class="btn btn-sm btn-outline-primary" style="display:none">TÃ i khoáº£n</button>
      <button id="btn-register" class="btn btn-sm btn-outline-dark">ÄÄƒng kÃ½</button>
      <button id="btn-login" class="btn btn-sm btn-dark">ÄÄƒng nháº­p</button>
      <button id="btn-logout" class="btn btn-sm btn-outline-secondary" style="display:none">ÄÄƒng xuáº¥t</button>
    </div>
  </div>

  <!-- HOME -->
  <section id="page-home">
    <div class="hero">
      <h1 style="margin:0;color:var(--accent)">Báº£n Ä‘á»“ sá»‘ PhÃº Quá»‘c</h1>
      <p style="margin-top:10px;margin-bottom:8px">Báº£n Ä‘á»“ sá»‘ PhÃº Quá»‘c lÃ  má»™t website giÃ¡o dá»¥c tÆ°Æ¡ng tÃ¡c â€” nÆ¡i há»c sinh khÃ¡m phÃ¡ di tÃ­ch, há»c lá»‹ch sá»­ qua trÃ² chÆ¡i vÃ  nháº­n huy hiá»‡u (badge). Ná»™i dung phÃ¹ há»£p vá»›i chá»§ Ä‘á» giÃ¡o dá»¥c lÃ²ng tá»± hÃ o dÃ¢n tá»™c vÃ  tÃ¬nh yÃªu quÃª hÆ°Æ¡ng.</p>
      <p style="margin:0 0 6px 0;color:#444">Trang web giÃºp há»c sinh: (1) hiá»ƒu giÃ¡ trá»‹ di tÃ­ch; (2) rÃ¨n ká»¹ nÄƒng ká»ƒ chuyá»‡n, dá»‹ch thuáº­t vÃ  tÆ° duy lá»‹ch sá»­; (3) tráº£i nghiá»‡m hoáº¡t Ä‘á»™ng há»c táº­p tÆ°Æ¡ng tÃ¡c, gáº§n gÅ©i Gen Z.</p>
      <p style="margin:0 0 8px 0;color:#444">Báº£n Ä‘á»“ sá»‘ lÃ  giáº£i phÃ¡p thuá»™c khuÃ´n khá»• dá»± Ã¡n khoa há»c kÄ© thuáº­t "<strong>GiÃ¡o dá»¥c lÃ²ng tá»± hÃ o dÃ¢n tá»™c vÃ  tÃ¬nh yÃªu quÃª hÆ°Æ¡ng Ä‘áº¥t nÆ°á»›c cho tuá»•i tráº» THPT An Thá»›i</strong>".</p>
      <div class="mt-3">
        <button id="btn-start" class="btn btn-accent btn-lg">Báº¯t Ä‘áº§u khÃ¡m phÃ¡</button>
      </div>
    </div>

    <div class="row g-3">
      <div class="col-md-6">
        <div class="game-card">
          <h5>Ã tÆ°á»Ÿng chÃ­nh</h5>
          <ul>
            <li>TÃ­ch há»£p báº£n Ä‘á»“ di tÃ­ch â€” má»—i Ä‘iá»ƒm cÃ³ tin, áº£nh, video vÃ  mini-game nhá».</li>
            <li>Badge & há»‡ Ä‘iá»ƒm khuyáº¿n khÃ­ch, dá»… Ä‘o lÆ°á»ng cho bÃ¡o cÃ¡o KHKT.</li>
            <li>PhÃ¹ há»£p pilot: cháº¡y á»Ÿ quy mÃ´ lá»›p/lá»›p há»c, khÃ´ng cáº§n mua host (GitHub Pages demo).</li>
          </ul>
        </div>
      </div>
      <div class="col-md-6">
        <div class="game-card">
          <h5>HÆ°á»›ng dáº«n nhanh</h5>
          <ol style="padding-left:18px">
            <li>Nháº¥n "Báº¯t Ä‘áº§u khÃ¡m phÃ¡" Ä‘á»ƒ sang trang báº£n Ä‘á»“.</li>
            <li>Click marker Ä‘á»ƒ xem thÃ´ng tin; náº¿u cÃ³ mini-game, báº¥m "ChÆ¡i".</li>
            <li>ÄÄƒng kÃ½/Ä‘Äƒng nháº­p Ä‘á»ƒ lÆ°u huy hiá»‡u (demo lÆ°u local).</li>
          </ol>
        </div>
      </div>
    </div>
  </section>

  <!-- MAP PAGE -->
  <section id="page-map" style="display:none">
    <div id="map" class="mb-3"></div>

    <div class="card p-3 mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <div style="font-weight:700">Huy hiá»‡u cá»§a báº¡n</div>
          <div style="color:#666;font-size:0.9rem">LÆ°u táº¡m trÃªn trÃ¬nh duyá»‡t (demo). Khi hoÃ n thÃ nh cÃ¡c Ä‘iá»u kiá»‡n, huy hiá»‡u sáº½ hiá»‡n á»Ÿ Ä‘Ã¢y.</div>
        </div>
        <div id="badge-area" class="d-flex gap-2"></div>
      </div>
    </div>

    <!-- profile area (simple) -->
    <div class="card p-3 mb-3">
      <div id="profile-area">
        <div style="font-weight:700">Trang cÃ¡ nhÃ¢n (demo)</div>
        <div id="profile-info" style="color:#444;margin-top:6px">Báº¡n chÆ°a Ä‘Äƒng nháº­p.</div>
      </div>
    </div>
  </section>

  <footer>
    Â© Dá»± Ã¡n KHKT â€” THPT An Thá»›i â€” Demo (miá»…n phÃ­)
  </footer>
</div>

<!-- DI TÃCH MODAL -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#d32);color:white">
        <h5 class="modal-title" id="diTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">Toáº¡ Ä‘á»™: <span id="diCoords"></span></small>
        </div>
        <button id="btn-checkin" class="btn btn-outline-success">Check-in (TÃ´i Ä‘Ã£ Ä‘áº¿n)</button>
        <button id="btn-play" class="btn btn-accent" style="display:none">ChÆ¡i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ÄÃ³ng</button>
      </div>
    </div>
  </div>
</div>

<!-- GAME MODAL -->
<div class="modal fade" id="gameModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:#222;color:var(--gold)">
        <h5 class="modal-title" id="gameTitle"></h5>
        <button class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="gameBody"></div>
      <div class="modal-footer">
        <div class="me-auto"><small id="gameNote" class="text-muted"></small></div>
        <button id="gameNext" class="btn btn-dark" style="display:none">Tiáº¿p</button>
        <button id="gameSubmit" class="btn btn-accent">HoÃ n thÃ nh</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ThoÃ¡t</button>
      </div>
    </div>
  </div>
</div>

<!-- AUTH modal -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header"><h5 class="modal-title" id="authTitle">ÄÄƒng kÃ½</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <input id="inName" class="form-control mb-2" placeholder="TÃªn hiá»ƒn thá»‹">
        <input id="inEmail" class="form-control mb-2" placeholder="Gmail">
        <input id="inPass" type="password" class="form-control mb-2" placeholder="Máº­t kháº©u">
        <div class="form-text">Demo lÆ°u táº¡i trÃ¬nh duyá»‡t. Äá»ƒ dÃ¹ng thá»±c, sáº½ hÆ°á»›ng dáº«n tÃ­ch há»£p Firebase.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">XÃ¡c nháº­n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Há»§y</button>
      </div>
    </div>
  </div>
</div>

<!-- Badge Popup Modal -->
<div id="badgePopup" class="badge-popup" style="display:none">
  <div class="badge-popup-content">
    <img id="badgePopupImg" src="" class="badge-popup-img" alt="Huy hiá»‡u">
    <div id="badgePopupTitle" class="badge-popup-title"></div>
    <div id="badgePopupMessage" class="badge-popup-message">ChÃºc má»«ng! Báº¡n Ä‘Ã£ nháº­n Ä‘Æ°á»£c huy hiá»‡u</div>
    <button id="badgePopupClose" class="btn btn-accent">Tuyá»‡t vá»i!</button>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ---------------------------
  Dá»¯ liá»‡u Ä‘iá»ƒm (Ä‘Ã£ cáº­p nháº­t vá»›i tá»a Ä‘á»™ chÃ­nh xÃ¡c cá»§a báº¡n)
----------------------------*/
const DI_TICH = [
  {
    id:'chua',
    name:'ChÃ¹a Há»™ Quá»‘c',
    address:'426H+GVQ, DÆ°Æ¡ng TÆ¡, PhÃº Quá»‘c, KiÃªn Giang, Viá»‡t Nam',
    note:'Thiá»n viá»‡n TrÃºc LÃ¢m Há»™ Quá»‘c â€” kiáº¿n trÃºc tÃ¢m linh lá»›n, phong cÃ¡ch cá»• truyá»n Viá»‡t.',
    extra:['NgÃ´i chÃ¹a lá»›n nháº¥t PhÃº Quá»‘c', 'Kiáº¿n trÃºc truyá»n thá»‘ng Viá»‡t Nam', 'KhÃ´ng gian tÃ¢m linh thanh tá»‹nh'],
    lat:10.110028, lng:104.029056, // 10Â°06'36.1"N 104Â°01'44.6"E
    games:[],
    img: 'images/chua.jpg'
  },
  {
    id:'nha-tu',
    name:'NhÃ  tÃ¹ PhÃº Quá»‘c',
    address:'350 Ä. Nguyá»…n VÄƒn Cá»«, An Thá»›i, PhÃº Quá»‘c, KiÃªn Giang, Viá»‡t Nam',
    note:'Di tÃ­ch lá»‹ch sá»­ cáº¥p Quá»‘c gia Ä‘áº·c biá»‡t (2014). NÆ¡i giam giá»¯ nhiá»u tÃ¹ binh trong khÃ¡ng chiáº¿n; chá»©ng tÃ­ch tra táº¥n, nhÆ°ng cÅ©ng lÃ  biá»ƒu tÆ°á»£ng Ã½ chÃ­ kiÃªn cÆ°á»ng.',
    extra:[
      'NÄƒm xÃ¢y dá»±ng: 01/06/1967',
      'CÃ²n gá»i: NhÃ  lao CÃ¢y Dá»«a',
      'Khoáº£ng 40.000 tÃ¹ binh tá»«ng bá»‹ giam; nhiá»u tÃ¹ nhÃ¢n bá»‹ tra táº¥n dÃ£ man. CÃ³ 45 cuá»™c vÆ°á»£t ngá»¥c ghi nháº­n.'
    ],
    lat:10.044417, lng:104.017639, // 10Â°02'39.9"N 104Â°01'03.5"E
    games:['quiz_nhatu','puzzle_nhatu','observe_nhatu'],
    img: 'images/nhatupq3.jpg'
  },
  {
    id:'nha-thung',
    name:'NhÃ  thÃ¹ng nÆ°á»›c máº¯m PhÃº Quá»‘c (Phá»¥ng HÆ°ng)',
    address:'471 Ä. Nguyá»…n VÄƒn Cá»«, Khu 2, PhÃº Quá»‘c, KiÃªn Giang',
    note:'NhÃ  thÃ¹ng nÆ°á»›c máº¯m truyá»n thá»‘ng; nghá» truyá»n thá»‘ng cá»§a Ä‘áº£o.',
    extra:['Lá»‹ch sá»­: hÃ ng trÄƒm nÄƒm, phÆ°Æ¡ng thá»©c á»§ muá»‘i truyá»n thá»‘ng', 'NÆ°á»›c máº¯m PhÃº Quá»‘c ná»•i tiáº¿ng thÆ¡m ngon'],
    lat:10.044917, lng:104.017444, // 10Â°02'41.7"N 104Â°01'02.8"E
    games:[],
    img:'images/nhathung.jpg'
  },
  {
    id:'ham-ninh',
    name:'LÃ ng chÃ i HÃ m Ninh',
    address:'52JV+6XX, TL47, Ráº¡ch HÃ m, PhÃº Quá»‘c, KiÃªn Giang, Viá»‡t Nam',
    note:'LÃ ng chÃ i cá»•, ná»•i tiáº¿ng háº£i sáº£n tÆ°Æ¡i, gháº¹ HÃ m Ninh.',
    extra:['LÃ ng chÃ i truyá»n thá»‘ng lÃ¢u Ä‘á»i', 'Ná»•i tiáº¿ng vá»›i gháº¹ HÃ m Ninh tÆ°Æ¡i ngon', 'Cáº£nh biá»ƒn Ä‘áº¹p, bÃ¬nh yÃªn'],
    lat:10.180917, lng:104.048472, // 10Â°10'51.3"N 104Â°02'54.5"E
    games:[],
    img:'images/langchai.jpg'
  },
  {
    id:'baotang',
    name:'Báº£o tÃ ng Cá»™i Nguá»“n',
    address:'PhÃº Quá»‘c, KiÃªn Giang',
    note:'Báº£o tÃ ng trÆ°ng bÃ y lá»‹ch sá»­-vÄƒn hÃ³a Ä‘á»‹a phÆ°Æ¡ng',
    extra:['TrÆ°ng bÃ y lá»‹ch sá»­, vÄƒn hÃ³a PhÃº Quá»‘c', 'Bá»™ sÆ°u táº­p cá»• váº­t phong phÃº', 'Kiáº¿n trÃºc Ä‘á»™c Ä‘Ã¡o'],
    lat:10.192500, lng:103.967000, // 10Â°11'33.0"N 103Â°58'01.2"E
    games:[],
    img:'images/coinguon.jpg'
  },
  {
    id:'dinh-cau',
    name:'Dinh Cáº­u',
    address:'Khu phá»‘ 2, Tp. PhÃº Quá»‘c, KiÃªn Giang 92500, Viá»‡t Nam',
    note:'Di tÃ­ch tháº¯ng cáº£nh; tÃ­n ngÆ°á»¡ng cá»§a ngÆ° dÃ¢n, cÃ³ lá»… há»™i hÃ ng nÄƒm (15â€“16/10 Ã¢m lá»‹ch).',
    extra:['XÃ¢y dá»±ng: 1937 (tu sá»­a 1997)','Biá»ƒu tÆ°á»£ng tÃ¢m linh cá»§a ngÆ°á»i dÃ¢n Ä‘á»‹a phÆ°Æ¡ng', 'Vá»‹ trÃ­ Ä‘áº¹p nhÃ¬n ra biá»ƒn'],
    lat:10.217194, lng:103.956500, // 10Â°13'01.9"N 103Â°57'23.4"E
    games:[],
    img:'images/dinhcau.jpg'
  },
  {
    id:'dinh-ntt',
    name:'ÄÃ¬nh Tháº§n Nguyá»…n Trung Trá»±c',
    address:'9RFV+848, GÃ nh Dáº§u, PhÃº Quá»‘c, KiÃªn Giang, Viá»‡t Nam',
    note:'Di tÃ­ch lá»‹ch sá»­ vÄƒn hÃ³a. ÄÃ¬nh thá» Anh hÃ¹ng dÃ¢n tá»™c Nguyá»…n Trung Trá»±c (1839-1868).',
    extra:[
      'ÄÃ¬nh Ä‘Æ°á»£c xÃ¢y dá»±ng tá»« nÄƒm 1882',
      'Lá»… giá»— tá»• chá»©c hÃ ng nÄƒm (Ã¢m lá»‹ch) â€” hoáº¡t Ä‘á»™ng truyá»n thá»‘ng hÆ¡n 100 nÄƒm',
      'Nguyá»…n Trung Trá»±c ná»•i tiáº¿ng vá»›i chiáº¿n cÃ´ng Ä‘á»‘t tÃ u PhÃ¡p trÃªn sÃ´ng Nháº­t Táº£o.'
    ],
    lat:10.373306, lng:103.842972, // 10Â°22'23.9"N 103Â°50'34.7"E
    games:['quiz_trungtruc','puzzle_trungtruc','timeline_trungtruc'],
    img:'images/dinhntt.jpg'
  }
];

/* -----------------------
  Local demo storage keys
------------------------*/
const STORAGE_USER = 'pq_user_demo_v1';
const STORAGE_BADGES = 'pq_badges_demo_v1';
const STORAGE_DONE = 'pq_done_games_v1';
const STORAGE_VISIT = 'pq_visited_v1';

/* --------- Helpers ------------- */
function saveUser(u){ localStorage.setItem(STORAGE_USER, JSON.stringify(u)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER) || 'null') }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES) || '[]') }
function saveBadges(a){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(a)) }
function loadDone(){ return JSON.parse(localStorage.getItem(STORAGE_DONE) || '{}') }
function saveDone(o){ localStorage.setItem(STORAGE_DONE, JSON.stringify(o)) }
function loadVisited(){ return JSON.parse(localStorage.getItem(STORAGE_VISIT) || '[]') }
function saveVisited(a){ localStorage.setItem(STORAGE_VISIT, JSON.stringify(a)) }

/* ---------- UI & Navigation ---------- */
const pageHome = document.getElementById('page-home');
const pageMap = document.getElementById('page-map');
const navHome = document.getElementById('nav-home');
const navMap = document.getElementById('nav-map');
const btnStart = document.getElementById('btn-start');
const btnRegister = document.getElementById('btn-register');
const btnLogin = document.getElementById('btn-login');
const btnLogout = document.getElementById('btn-logout');
const btnProfileNav = document.getElementById('btn-profile');

function showHome(){ pageHome.style.display='block'; pageMap.style.display='none'; }
function showMap(){ pageHome.style.display='none'; pageMap.style.display='block'; setTimeout(()=> map.invalidateSize(),300); }

navHome.onclick = showHome;
navMap.onclick = showMap;
btnStart.onclick = ()=> { showMap(); window.scrollTo(0,0); }

/* Auth modal */
const authModal = new bootstrap.Modal(document.getElementById('authModal'));
document.getElementById('btn-register').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ÄÄƒng kÃ½'; document.getElementById('authSubmit').onclick = authRegister; document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-login').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ÄÄƒng nháº­p'; document.getElementById('authSubmit').onclick = authLogin; document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-logout').addEventListener('click', ()=> {
  localStorage.removeItem(STORAGE_USER);
  refreshAuthUI();
  alert('ÄÄƒng xuáº¥t thÃ nh cÃ´ng (demo).');
});

/* auth functions */
function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('Äiá»n Ä‘á»§ tÃªn, email, máº­t kháº©u'); return; }
  // simple store (demo) â€” overwrite allowed
  const u = {name,email,pass};
  saveUser(u);
  alert('ÄÄƒng kÃ½ thÃ nh cÃ´ng (demo). Vui lÃ²ng Ä‘Äƒng nháº­p.');
  authModal.hide();
}
function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  const u = loadUser();
  if(!u || u.email !== email || u.pass !== pass){ showAuthError('Email hoáº·c máº­t kháº©u khÃ´ng Ä‘Ãºng (demo)'); return; }
  // login success
  authModal.hide();
  refreshAuthUI();
  alert('ÄÄƒng nháº­p thÃ nh cÃ´ng. Xin chÃ o ' + u.name);
}
function showAuthError(msg){ const a=document.getElementById('authAlert'); a.innerText=msg; a.classList.remove('d-none'); }
function refreshAuthUI(){
  const u = loadUser();
  if(u){ document.getElementById('btn-login').style.display='none'; document.getElementById('btn-register').style.display='none'; document.getElementById('btn-logout').style.display='inline-block'; document.getElementById('btn-profile').style.display='inline-block'; document.getElementById('btn-profile').innerText = u.name; document.getElementById('profile-info').innerText = `Xin chÃ o, ${u.name} â€” ${u.email}`; renderBadges(); } else { document.getElementById('btn-login').style.display='inline-block'; document.getElementById('btn-register').style.display='inline-block'; document.getElementById('btn-logout').style.display='none'; document.getElementById('btn-profile').style.display='none'; document.getElementById('profile-info').innerText = 'Báº¡n chÆ°a Ä‘Äƒng nháº­p.'; renderBadges(); }
}
btnProfileNav.addEventListener('click', ()=> { showMap(); window.scrollTo(0,0); });

/* ---------- Map init ---------- */
const map = L.map('map', {zoomControl:true}).setView([10.28,103.98], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'Â© OpenStreetMap'}).addTo(map);

function makeIcon(hasGame){
  const color = hasGame ? '#C62828' : '#1976D2';
  return L.divIcon({className:'custom-pin', html:`<div style="background:${color};width:18px;height:18px;border-radius:50%;border:3px solid white"></div>`, iconSize:[24,24], iconAnchor:[12,12]});
}

/* render markers */
DI_TICH.forEach(p=>{
  const m = L.marker([p.lat,p.lng], {icon: makeIcon(p.games.length>0)}).addTo(map);
  m.on('click', ()=> openDiModal(p));
});

/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));
const gameModal = new bootstrap.Modal(document.getElementById('gameModal'));

/* open di tÃ­ch modal (with details) */
function openDiModal(p){
  document.getElementById('diTitle').innerText = p.name;
  // build html content with full details
  const extras = p.extra.map(x=>`<li>${x}</li>`).join('');
  const html = `
    <div class="row">
      <div class="col-md-5"><img src="${p.img}" alt="${p.name}" style="width:100%;border-radius:8px;object-fit:cover"></div>
      <div class="col-md-7">
        <h5 class="diatic-title">${p.name}</h5>
        <p style="margin:0">${p.address}</p>
        <p style="margin-top:8px;color:#333">${p.note}</p>
        ${extras ? `<ul>${extras}</ul>` : ''}
      </div>
    </div>
  `;
  document.getElementById('diBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${p.lat.toFixed(6)}, ${p.lng.toFixed(6)}`;
  const btnPlay = document.getElementById('btn-play');
  if(p.games && p.games.length){
    btnPlay.style.display='inline-block';
    btnPlay.onclick = ()=> { diModal.hide(); openGamePicker(p); };
  } else { btnPlay.style.display='none'; btnPlay.onclick=null; }
  // check-in button
  document.getElementById('btn-checkin').onclick = ()=> {
    const u = loadUser();
    if(!u){ alert('Vui lÃ²ng Ä‘Äƒng nháº­p trÆ°á»›c khi check-in.'); return; }
    markVisited(p.id);
    awardBadgeSite(p.id,p.name);
  };
  diModal.show();
}

/* ---------- Badges & check-in logic ---------- */
/* Badges rules (as you specified):
  - Check-in at a site => badge per site (site badge)
  - Complete a quiz => "NhÃ  sá»­ há»c táº­p sá»±"
  - Complete both quizzes => "NhÃ  sá»­ há»c tÃ i ba"
  - Complete a puzzle (image assembly) => "Thá»£ ghÃ©p tranh tÃ i ba"
  - Complete both puzzles => "NhÃ  phá»¥c cháº¿ tÃ i hoa"
  - Collect all badges => "NgÆ°á»i giá»¯ lá»­a di sáº£n"
*/
function getBadges(){ return loadBadges(); }
function awardBadge(id,name,icon){
  const arr = getBadges();
  if(arr.find(b=>b.id===id)) return false;
  arr.push({id,name,icon:icon || `https://via.placeholder.com/64/FFD54F/000?text=${encodeURIComponent(name.charAt(0))}`});
  saveBadges(arr);
  renderBadges();
  confetti({particleCount:80,spread:60,origin:{y:0.4}});
  return true;
}
function renderBadges(){
  const wrap = document.getElementById('badge-area');
  wrap.innerHTML = '';
  const arr = getBadges();
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.innerHTML = `<div style="text-align:center"><img src="${b.icon}" class="badge-img"><div style="font-size:12px">${b.name}</div></div>`;
    wrap.appendChild(el);
  });
  // also show in profile area if logged in
  const u = loadUser();
  if(u){
    document.getElementById('profile-info').innerHTML = `Xin chÃ o ${u.name} â€” <div style="margin-top:6px">Huy hiá»‡u: ${arr.map(x=>x.name).join(', ') || 'ChÆ°a cÃ³'}</div>`;
  }
}

/* mark visited and award site badge */
function markVisited(siteId){
  const v = loadVisited();
  if(!v.includes(siteId)){ v.push(siteId); saveVisited(v); checkAggregateBadges(); renderBadges(); }
}
function awardBadgeSite(siteId, siteName){
  const id = `site_${siteId}`;
  const name = `${siteName}`;
  // Táº¡o mapping giá»¯a siteId vÃ  URL áº£nh huy hiá»‡u
  const badgeIcons = {
    'chua': 'images/hhchua.jpg',
    'nha-tu': 'images/hhnhatupq.jpg',
    'nha-thung': 'images/hhnhathung.jpg',
    'ham-ninh': 'images/hhlangchai.jpg',
    'baotang': 'images/hhcoinguon.jpg',
    'dinh-cau': 'images/hhdinhcau.jpg',
    'dinh-ntt': 'images/hhdinhntt.jpg'
  };
  
  const badgeIcon = badgeIcons[siteId] || `https://via.placeholder.com/64/C33/fff?text=${encodeURIComponent(siteName.split(' ')[0].charAt(0))}`;
  
  // Hiá»ƒn thá»‹ popup huy hiá»‡u
  showBadgePopup(name, badgeIcon);
  
  awardBadge(id, name, badgeIcon);
}

/* Hiá»ƒn thá»‹ popup huy hiá»‡u lá»›n */
function showBadgePopup(badgeName, badgeIcon) {
  const popup = document.getElementById('badgePopup');
  const popupImg = document.getElementById('badgePopupImg');
  const popupTitle = document.getElementById('badgePopupTitle');
  const popupClose = document.getElementById('badgePopupClose');
  
  // Thiáº¿t láº­p ná»™i dung
  popupImg.src = badgeIcon;
  popupTitle.textContent = badgeName;
  
  // Hiá»ƒn thá»‹ popup
  popup.style.display = 'flex';
  
  // Báº¯n phÃ¡o hoa
  confetti({
    particleCount: 150,
    spread: 70,
    origin: { y: 0.6 },
    colors: ['#C62828', '#FFD54F', '#4CAF50', '#2196F3']
  });
  
  // Tá»± Ä‘á»™ng táº¯t sau 3 giÃ¢y hoáº·c khi click
  const autoClose = setTimeout(() => {
    closeBadgePopup();
  }, 3000);
  
  // Sá»± kiá»‡n click Ä‘á»ƒ Ä‘Ã³ng
  popupClose.onclick = () => {
    clearTimeout(autoClose);
    closeBadgePopup();
  };
  
  // Click ra ngoÃ i Ä‘á»ƒ Ä‘Ã³ng
  popup.onclick = (e) => {
    if (e.target === popup) {
      clearTimeout(autoClose);
      closeBadgePopup();
    }
  };
}

function closeBadgePopup() {
  const popup = document.getElementById('badgePopup');
  popup.style.display = 'none';
}

/* record game completion */
function recordDone(siteId, gameId){
  const o = loadDone();
  if(!o[siteId]) o[siteId]=[];
  if(!o[siteId].includes(gameId)){ o[siteId].push(gameId); saveDone(o); checkAggregateBadges(); renderBadges(); }
}

/* check aggregate badges */
function checkAggregateBadges(){
  const done = loadDone();
  const visited = loadVisited();
  // badge1: complete all games at NhÃ  tÃ¹ (3)
  if(done['nha-tu'] && done['nha-tu'].length >= 3) awardBadge('badge_nhatu_all','Anh hÃ¹ng báº£o vá»‡ biá»ƒn Ä‘áº£o');
  // badge2: complete all games at ÄÃ¬nh NTT (3)
  if(done['dinh-ntt'] && done['dinh-ntt'].length >= 3) awardBadge('badge_dinh_all','ChÃ­nh khÃ­ Nguyá»…n Trung Trá»±c');
  // quiz badges: if completed quiz at nha-tu or dinh -> award "NhÃ  sá»­ há»c táº­p sá»±" per quiz, and if both quizzes done award "NhÃ  sá»­ há»c tÃ i ba"
  const quizzesDone = [];
  if(done['nha-tu'] && done['nha-tu'].includes('quiz_nhatu')) quizzesDone.push('nha-tu');
  if(done['dinh-ntt'] && done['dinh-ntt'].includes('quiz_trungtruc')) quizzesDone.push('dinh-ntt');
  if(done['nha-tu'] && done['nha-tu'].includes('quiz_nhatu')) awardBadge('badge_quiz_nhatu','NhÃ  sá»­ há»c táº­p sá»± (NhÃ  tÃ¹)');
  if(done['dinh-ntt'] && done['dinh-ntt'].includes('quiz_trungtruc')) awardBadge('badge_quiz_dinh','NhÃ  sá»­ há»c táº­p sá»± (ÄÃ¬nh)');
  if(quizzesDone.length >= 2) awardBadge('badge_quiz_all','NhÃ  sá»­ há»c tÃ i ba');
  // puzzle badges
  const puzzlesDone = [];
  if(done['nha-tu'] && (done['nha-tu'].includes('puzzle_nhatu') || done['nha-tu'].includes('puzzle_nhatu2'))) puzzlesDone.push('nha-tu');
  if(done['dinh-ntt'] && (done['dinh-ntt'].includes('puzzle_trungtruc') || done['dinh-ntt'].includes('puzzle_trungtruc2'))) puzzlesDone.push('dinh-ntt');
  if(done['nha-tu'] && done['nha-tu'].includes('puzzle_nhatu')) awardBadge('badge_puzzle_nhatu','Thá»£ ghÃ©p tranh tÃ i ba (NhÃ  tÃ¹)');
  if(done['dinh-ntt'] && done['dinh-ntt'].includes('puzzle_trungtruc')) awardBadge('badge_puzzle_dinh','Thá»£ ghÃ©p tranh tÃ i ba (ÄÃ¬nh)');
  // combined puzzle master
  if(puzzlesDone.length >= 2) awardBadge('badge_puzzle_all','NhÃ  phá»¥c cháº¿ tÃ i hoa');
  // final all badges
  const all = getBadges();
  const needed = [
    // site badges
    `site_nha-tu`,`site_dinh-ntt`,`site_dinh-cau`,`site_chua`,`site_ham-ninh`,`site_nha-thung`,`site_baotang`,
    // some others: quiz & puzzles
    'badge_quiz_all','badge_puzzle_all'
  ];
  const hasAll = needed.every(k => all.find(x=>x.id===k));
  if(hasAll) awardBadge('badge_master','NgÆ°á»i giá»¯ lá»­a di sáº£n','https://via.placeholder.com/64/FF7043/fff?text=%F0%9F%94%A5');
}

/* ---------- Game picker & implementations ---------- */
function openGamePicker(site){
  document.getElementById('gameTitle').innerText = `Mini-game â€” ${site.name}`;
  // build a selection
  const html = `<div><p>Chá»n mini-game:</p><div class="d-flex gap-2 flex-wrap">` +
    site.games.map(g=>`<button class="btn btn-outline-dark game-choice" data-game="${g}">${labelGame(g)}</button>`).join('') +
    `</div></div>`;
  document.getElementById('gameBody').innerHTML = html;
  document.getElementById('gameNote').innerText = 'Má»—i mini-game cÃ³ 1â€“6 bÆ°á»›c. Káº¿t quáº£ sáº½ lÆ°u vÃ o há»“ sÆ¡ cá»§a báº¡n (demo).';
  document.getElementById('gameSubmit').style.display='none';
  document.getElementById('gameNext').style.display='none';
  gameModal.show();
  // attach click listeners
  document.querySelectorAll('.game-choice').forEach(btn=> btn.addEventListener('click', ()=> {
    const g = btn.dataset.game;
    startGameInstance(g, site);
  }));
}

function labelGame(id){
  const map = {
    'quiz_nhatu':'Quiz (NhÃ  tÃ¹)',
    'puzzle_nhatu':'Máº£nh ghÃ©p lá»‹ch sá»­ (NhÃ  tÃ¹)',
    'observe_nhatu':'Quan sÃ¡t & tráº£ lá»i (NhÃ  tÃ¹)',
    'quiz_trungtruc':'Quiz (ÄÃ¬nh)',
    'puzzle_trungtruc':'Máº£nh ghÃ©p lá»‹ch sá»­ (ÄÃ¬nh)',
    'timeline_trungtruc':'Sáº¯p xáº¿p má»‘c (ÄÃ¬nh)'
  };
  return map[id]||id;
}

/* ---------- GAME GHÃ‰P HÃŒNH Má»šI - Má»–I ÄIá»‚M 1 áº¢NH ---------- */
const PUZZLE_GAMES = {
  'puzzle_nhatu': {
    title: 'Máº£nh ghÃ©p lá»‹ch sá»­ - NhÃ  tÃ¹ PhÃº Quá»‘c',
    image: 'images/chuongcop.jpg', // áº¢nh chuá»“ng cá»p káº½m gai
    pieces: 12, // 4x3 grid
    info: 'Chuá»“ng cá»p káº½m gai táº¡i NhÃ  tÃ¹ PhÃº Quá»‘c - má»™t trong nhá»¯ng hÃ¬nh thá»©c tra táº¥n dÃ£ man nháº¥t. TÃ¹ nhÃ¢n bá»‹ nhá»‘t trong cÃ¡c chuá»“ng sáº¯t nhá» háº¹p vá»›i hÃ ng rÃ o káº½m gai bao quanh, khÃ´ng thá»ƒ Ä‘á»©ng tháº³ng hay náº±m thoáº£i mÃ¡i. Há» pháº£i chá»‹u Ä‘á»±ng cÃ¡i nÃ³ng thiÃªu Ä‘á»‘t ban ngÃ y vÃ  cÃ¡i láº¡nh buá»‘t xÆ°Æ¡ng ban Ä‘Ãªm, cÃ¹ng vá»›i nhá»¯ng váº¿t thÆ°Æ¡ng do káº½m gai gÃ¢y ra.'
  },
  'puzzle_trungtruc': {
    title: 'Máº£nh ghÃ©p lá»‹ch sá»­ - ÄÃ¬nh Nguyá»…n Trung Trá»±c',
    image: 'images/ngoidinhntt.jpg', // áº¢nh ngÃ´i Ä‘Ã¬nh
    pieces: 9, // 3x3 grid
    info: 'ÄÃ¬nh tháº§n Nguyá»…n Trung Trá»±c - cÃ´ng trÃ¬nh kiáº¿n trÃºc tÃ¢m linh quan trá»ng báº­c nháº¥t á»Ÿ PhÃº Quá»‘c. ÄÃ¬nh Ä‘Æ°á»£c xÃ¢y dá»±ng tá»« nÄƒm 1882 Ä‘á»ƒ thá» vá»‹ anh hÃ¹ng dÃ¢n tá»™c Nguyá»…n Trung Trá»±c - ngÆ°á»i Ä‘Ã£ cÃ³ cÃ´ng lá»›n trong cuá»™c khÃ¡ng chiáº¿n chá»‘ng thá»±c dÃ¢n PhÃ¡p. Kiáº¿n trÃºc Ä‘Ã¬nh mang Ä‘áº­m phong cÃ¡ch Nam Bá»™ vá»›i mÃ¡i ngÃ³i Ã¢m dÆ°Æ¡ng, cá»™t gá»— quÃ½ vÃ  cÃ¡c há»a tiáº¿t trang trÃ­ tinh xáº£o.'
  }
};

let currentPuzzleGame = null;
let placedPieces = 0;

function startPuzzleGame(gameId, site) {
  const puzzleData = PUZZLE_GAMES[gameId];
  if (!puzzleData) {
    alert('Game ghÃ©p hÃ¬nh chÆ°a cÃ³ ná»™i dung.');
    return;
  }

  currentPuzzleGame = { id: gameId, site: site, puzzleData: puzzleData };
  placedPieces = 0;
  
  loadPuzzle();
  
  document.getElementById('gameTitle').innerText = puzzleData.title;
  document.getElementById('gameNote').innerText = 'KÃ©o tháº£ cÃ¡c máº£nh ghÃ©p vÃ o Ä‘Ãºng vá»‹ trÃ­ trÃªn báº£ng';
  document.getElementById('gameSubmit').style.display = 'none';
  document.getElementById('gameNext').style.display = 'none';
  
  gameModal.show();
}

function loadPuzzle() {
  const puzzle = currentPuzzleGame.puzzleData;
  const rows = Math.sqrt(puzzle.pieces); // Giáº£ sá»­ sá»‘ máº£nh lÃ  sá»‘ chÃ­nh phÆ°Æ¡ng
  const cols = puzzle.pieces / rows;
  
  const html = `
    <div class="puzzle-container">
      <div class="puzzle-title">Máº£nh ghÃ©p lá»‹ch sá»­</div>
      <div class="puzzle-progress">ÄÃ£ ghÃ©p: <span id="placedCount">0</span>/${puzzle.pieces} máº£nh</div>
      
      <div class="puzzle-area">
        <div class="puzzle-pieces" id="puzzlePieces"></div>
        <div class="puzzle-board" id="puzzleBoard"></div>
      </div>
      
      <div class="puzzle-info" id="puzzleInfo"></div>
      <div class="puzzle-complete" id="puzzleComplete">
        <h5>ğŸ‰ ChÃºc má»«ng!</h5>
        <p>Báº¡n Ä‘Ã£ hoÃ n thÃ nh ghÃ©p hÃ¬nh!</p>
        <button class="btn btn-accent mt-2" onclick="finishPuzzleGame()">HoÃ n thÃ nh</button>
      </div>
    </div>
  `;
  
  document.getElementById('gameBody').innerHTML = html;
  
  // Táº¡o cÃ¡c máº£nh ghÃ©p
  const piecesContainer = document.getElementById('puzzlePieces');
  const board = document.getElementById('puzzleBoard');
  
  // Táº¡o board vá»›i cÃ¡c Ã´
  board.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  board.style.gridTemplateRows = `repeat(${rows}, 1fr)`;
  
  for (let i = 0; i < puzzle.pieces; i++) {
    const slot = document.createElement('div');
    slot.className = 'puzzle-slot';
    slot.dataset.index = i;
    board.appendChild(slot);
    
    const piece = document.createElement('div');
    piece.className = 'puzzle-piece';
    piece.draggable = true;
    piece.dataset.index = i;
    
    // TÃ­nh toÃ¡n background position cho má»—i máº£nh
    const row = Math.floor(i / cols);
    const col = i % cols;
    const bgX = -col * 100;
    const bgY = -row * 100;
    
    piece.style.backgroundImage = `url('${puzzle.image}')`;
    piece.style.backgroundPosition = `${bgX}% ${bgY}%`;
    piece.style.backgroundSize = `${cols * 100}% ${rows * 100}%`;
    
    // Sá»± kiá»‡n drag and drop
    piece.addEventListener('dragstart', handleDragStart);
    piece.addEventListener('dragend', handleDragEnd);
    
    piecesContainer.appendChild(piece);
  }
  
  // Sá»± kiá»‡n cho cÃ¡c Ã´ trÃªn board
  const slots = document.querySelectorAll('.puzzle-slot');
  slots.forEach(slot => {
    slot.addEventListener('dragover', handleDragOver);
    slot.addEventListener('drop', handleDrop);
    slot.addEventListener('dragenter', handleDragEnter);
    slot.addEventListener('dragleave', handleDragLeave);
  });
  
  // XÃ¡o trá»™n cÃ¡c máº£nh ghÃ©p
  shufflePieces();
}

function shufflePieces() {
  const pieces = document.querySelectorAll('.puzzle-piece');
  const piecesArray = Array.from(pieces);
  const piecesContainer = document.getElementById('puzzlePieces');
  
  for (let i = piecesArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    piecesContainer.appendChild(piecesArray[j]);
  }
}

// Drag and Drop handlers
let draggedPiece = null;

function handleDragStart(e) {
  draggedPiece = this;
  this.style.opacity = '0.4';
  e.dataTransfer.effectAllowed = 'move';
}

function handleDragEnd(e) {
  this.style.opacity = '1';
  draggedPiece = null;
}

function handleDragOver(e) {
  e.preventDefault();
  return false;
}

function handleDragEnter(e) {
  this.classList.add('hover');
}

function handleDragLeave(e) {
  this.classList.remove('hover');
}

function handleDrop(e) {
  e.preventDefault();
  this.classList.remove('hover');
  
  if (draggedPiece && !this.hasChildNodes()) {
    const pieceIndex = parseInt(draggedPiece.dataset.index);
    const slotIndex = parseInt(this.dataset.index);
    
    if (pieceIndex === slotIndex) {
      // ÄÃºng vá»‹ trÃ­
      this.appendChild(draggedPiece);
      this.classList.add('filled');
      draggedPiece.style.cursor = 'default';
      draggedPiece.draggable = false;
      
      placedPieces++;
      document.getElementById('placedCount').textContent = placedPieces;
      
      // Kiá»ƒm tra hoÃ n thÃ nh
      if (placedPieces === currentPuzzleGame.puzzleData.pieces) {
        showPuzzleInfo();
      }
    } else {
      // Sai vá»‹ trÃ­ - hiá»‡u á»©ng láº¯c
      draggedPiece.style.animation = 'shake 0.5s';
      setTimeout(() => {
        draggedPiece.style.animation = '';
      }, 500);
    }
  }
  
  return false;
}

function showPuzzleInfo() {
  const puzzle = currentPuzzleGame.puzzleData;
  const infoDiv = document.getElementById('puzzleInfo');
  const completeDiv = document.getElementById('puzzleComplete');
  
  infoDiv.innerHTML = `<h6>ThÃ´ng tin lá»‹ch sá»­:</h6><p>${puzzle.info}</p>`;
  infoDiv.classList.add('show');
  completeDiv.classList.add('show');
}

function finishPuzzleGame() {
  recordDone(currentPuzzleGame.site.id, currentPuzzleGame.id);
  alert(`ChÃºc má»«ng! Báº¡n Ä‘Ã£ hoÃ n thÃ nh ghÃ©p hÃ¬nh vá» ${currentPuzzleGame.site.name}`);
  gameModal.hide();
}

/* ---------- CÃC GAME KHÃC ---------- */

/* Game: QUIZ that shows one question at a time with immediate feedback & explanation */
const QUIZZES = {
  'quiz_nhatu': {
    title:'Quiz NhÃ  tÃ¹ PhÃº Quá»‘c',
    items:[
      {
        q:'Di tÃ­ch Tráº¡i giam PhÃº Quá»‘c Ä‘Æ°á»£c chÃ­nh thá»©c xáº¿p háº¡ng Di tÃ­ch Quá»‘c gia Ä‘áº·c biá»‡t vÃ o thá»i Ä‘iá»ƒm nÃ o?',
        opts:['NgÃ y 30/4/1975','NgÃ y 27/7/2013','NgÃ y 31/12/2014','NgÃ y 20/10/2016'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. CÄƒn cá»© theo Quyáº¿t Ä‘á»‹nh sá»‘ 2408/QÄ-TTg ngÃ y 31/12/2014 cá»§a Thá»§ tÆ°á»›ng ChÃ­nh phá»§.'
      },
      {
        q:'"Äá»‹a ngá»¥c tráº§n gian" PhÃº Quá»‘c chÃ­nh thá»©c tá»“n táº¡i trong khoáº£ng thá»i gian nÃ o?',
        opts:['Tá»« nÄƒm 1949 Ä‘áº¿n nÄƒm 1954','Tá»« thÃ¡ng 6/1967 Ä‘áº¿n thÃ¡ng 3/1973','Tá»« nÄƒm 1965 Ä‘áº¿n nÄƒm 1975','Tá»« nÄƒm 1954 Ä‘áº¿n nÄƒm 1975'],
        ans:1,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  B. Theo tÆ° liá»‡u, tráº¡i giam tá»“n táº¡i chÆ°a Ä‘áº§y 6 nÄƒm trong giai Ä‘oáº¡n nÃ y dÆ°á»›i sá»± quáº£n lÃ½ cá»§a chÃ­nh quyá»n Má»¹ - Ngá»¥y.'
      },
      {
        q:'Æ¯á»›c tÃ­nh cÃ³ bao nhiÃªu tÃ¹ binh Ä‘Ã£ bá»‹ giáº¿t háº¡i táº¡i Tráº¡i giam PhÃº Quá»‘c?',
        opts:['Khoáº£ng 1.000 ngÆ°á»i','Khoáº£ng 2.000 ngÆ°á»i','Khoáº£ng 4.000 ngÆ°á»i','Khoáº£ng 10.000 ngÆ°á»i'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. TÆ° liá»‡u ghi rÃµ con sá»‘ khoáº£ng 4.000 tÃ¹ binh Ä‘Ã£ bá»‹ giáº¿t háº¡i táº¡i Ä‘Ã¢y.'
      },
      {
        q:'Má»™t trong nhá»¯ng hÃ¬nh thá»©c tra táº¥n Ä‘áº·c biá»‡t dÃ£ man, nÆ¡i tÃ¹ binh bá»‹ nhá»‘t trong cÃ¡c cÃ´ng-ten-nÆ¡ nhá» Ä‘Æ°á»£c gá»i lÃ  gÃ¬?',
        opts:['Chuá»“ng cá»p xi mÄƒng','ThÃ¹ng cat-xÃ´','Háº§m Ä‘Ã¡ vÃ´i','Ngá»¥c tá»‘i'],
        ans:1,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  B. ÄÃ¢y lÃ  má»™t kiá»ƒu giam giá»¯ Ä‘Æ°á»£c mÃ´ táº£ trong tÆ° liá»‡u, sá»­ dá»¥ng cÃ¡c cÃ´ng-ten-nÆ¡ nhá», trÃªn Ä‘á»‰nh Ä‘á»¥c lá»— thÃ´ng hÆ¡i, ráº¥t cháº­t háº¹p vÃ  ngá»™t ngáº¡t.'
      },
      {
        q:'CÃ¡c tÃ¹ binh táº¡i Tráº¡i giam PhÃº Quá»‘c Ä‘Ã£ tá»• chá»©c bao nhiÃªu cuá»™c vÆ°á»£t ngá»¥c vá»›i nhiá»u hÃ¬nh thá»©c khÃ¡c nhau?',
        opts:['12 cuá»™c','25 cuá»™c','45 cuá»™c','52 cuá»™c'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. Thá»ƒ hiá»‡n tinh tháº§n Ä‘áº¥u tranh báº¥t khuáº¥t, cÃ¡c tÃ¹ binh Ä‘Ã£ tá»• chá»©c thÃ nh cÃ´ng 45 cuá»™c vÆ°á»£t ngá»¥c.'
      },
      {
        q:'Khu vá»±c nÃ o sau Ä‘Ã¢y KHÃ”NG pháº£i lÃ  má»™t pháº§n cá»§a Di tÃ­ch Tráº¡i giam PhÃº Quá»‘c ngÃ y nay?',
        opts:['PhÃ¢n khu B2 (Ä‘Æ°á»£c phá»¥c dá»±ng)','NghÄ©a Ä‘á»‹a tÃ¹ binh (Äá»“i 100)','NhÃ  tÃ¹ CÃ´n SÆ¡n','ÄÃ i tÆ°á»Ÿng niá»‡m liá»‡t sÄ© táº¡i Äá»“i Sim'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. NhÃ  tÃ¹ CÃ´n SÆ¡n lÃ  má»™t di tÃ­ch lá»‹ch sá»­ hoÃ n toÃ n khÃ¡c, náº±m á»Ÿ CÃ´n Äáº£o, tá»‰nh BÃ  Rá»‹a - VÅ©ng TÃ u.'
      },
      {
        q:'Tá»•ng diá»‡n tÃ­ch cá»§a Tráº¡i giam PhÃº Quá»‘c trong lá»‹ch sá»­ lÃªn Ä‘áº¿n bao nhiÃªu?',
        opts:['100 hecta','200 hecta','400 hecta','500 hecta'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. Tráº¡i giam cÃ³ quy mÃ´ ráº¥t lá»›n, vá»›i tá»•ng diá»‡n tÃ­ch lÃªn Ä‘áº¿n 400 hecta, Ä‘Æ°á»£c chia thÃ nh 12 khu vá»±c.'
      }
    ]
  },
  'quiz_trungtruc': {
    title:'Quiz ÄÃ¬nh Nguyá»…n Trung Trá»±c',
    items:[
      {
        q:'Nguyá»…n Trung Trá»±c lÃ  thá»§ lÄ©nh ná»•i tiáº¿ng cá»§a phong trÃ o khÃ¡ng chiáº¿n chá»‘ng?',
        opts:['Chá»‘ng PhÃ¡p','Chá»‘ng PhÃ¡p vÃ  chá»‘ng Má»¹','Chá»‘ng Má»¹','Chá»‘ng Nháº­t'],
        ans:0,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  A. Nguyá»…n Trung Trá»±c lÃ  thá»§ lÄ©nh nghÄ©a quÃ¢n chá»‘ng láº¡i thá»±c dÃ¢n PhÃ¡p xÃ¢m lÆ°á»£c á»Ÿ Nam Ká»³ vÃ o ná»­a cuá»‘i tháº¿ ká»· 19 (tá»« 1861-1868).'
      },
      {
        q:'Nguyá»…n Trung Trá»±c Ä‘Ã£ chá»‰ huy nghÄ©a quÃ¢n Ä‘á»‘t chÃ¡y tÃ u chiáº¿n nÃ o cá»§a PhÃ¡p trÃªn sÃ´ng VÃ m Cá» ÄÃ´ng vÃ o nÄƒm 1861, gÃ¢y tiáº¿ng vang lá»›n?',
        opts:['TÃ u Hy Vá»ng (L\'EspÃ©rance)','TÃ u Háº±ng TÃ¢m (La PersÃ©vÃ©rance)','TÃ u JaccarÃ©','TÃ u Avalanche'],
        ans:0,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  A. Chiáº¿n cÃ´ng ná»•i tiáº¿ng nháº¥t cá»§a Ã´ng lÃ  chá»‰ huy nghÄ©a quÃ¢n Ä‘á»‘t chÃ¡y tiá»ƒu háº¡m L\'EspÃ©rance (cÃ³ tÃªn Viá»‡t lÃ  "Hy Vá»ng") cá»§a PhÃ¡p trÃªn sÃ´ng VÃ m Cá» ÄÃ´ng nÄƒm 1861.'
      },
      {
        q:'CÃ¢u nÃ³i báº¥t há»§ "Bao giá» ngÆ°á»i TÃ¢y nhá»• háº¿t cá» nÆ°á»›c Nam thÃ¬ má»›i háº¿t ngÆ°á»i Nam Ä‘Ã¡nh TÃ¢y" Ä‘Æ°á»£c Nguyá»…n Trung Trá»±c nÃ³i trong hoÃ n cáº£nh nÃ o?',
        opts:['Khi Ä‘á»™ng viÃªn nghÄ©a quÃ¢n trÆ°á»›c tráº­n Ä‘Ã¡nh','Khi bá»‹ thá»±c dÃ¢n PhÃ¡p dá»¥ hÃ ng vÃ  káº¿t Ã¡n tá»­ hÃ¬nh','Khi tráº£ lá»i phá»ng váº¥n cá»§a má»™t nhÃ  bÃ¡o PhÃ¡p','Trong má»™t bá»©c thÆ° gá»­i cho Triá»u Ä‘Ã¬nh Huáº¿'],
        ans:1,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  B. CÃ¢u nÃ³i báº¥t há»§ nÃ y thá»ƒ hiá»‡n khÃ­ phÃ¡ch kiÃªn cÆ°á»ng cá»§a Ã´ng, Ä‘Æ°á»£c Ã´ng thá»‘t lÃªn khi Ä‘á»‘i diá»‡n vá»›i cÃ¡i cháº¿t, trÆ°á»›c sá»± dá»¥ dá»— cá»§a káº» thÃ¹.'
      },
      {
        q:'Nguyá»…n Trung Trá»±c bá»‹ thá»±c dÃ¢n PhÃ¡p xá»­ chÃ©m táº¡i Ä‘Ã¢u?',
        opts:['SÃ i GÃ²n','Báº¿n Tre','Ráº¡ch GiÃ¡','Cáº§n ThÆ¡'],
        ans:2,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  C. Sau khi khÃ¡ng chiáº¿n á»Ÿ HÃ²n ChÃ´ng tháº¥t báº¡i vÃ  bá»‹ báº¯t, Ã´ng bá»‹ thá»±c dÃ¢n PhÃ¡p xá»­ chÃ©m táº¡i chá»£ Ráº¡ch GiÃ¡ vÃ o ngÃ y 27/10/1868 (16/9 nÄƒm Máº­u ThÃ¬n).'
      },
      {
        q:'Lá»… há»™i tÆ°á»Ÿng niá»‡m Nguyá»…n Trung Trá»±c Ä‘Æ°á»£c tá»• chá»©c háº±ng nÄƒm vÃ o nhá»¯ng ngÃ y nÃ o?',
        opts:['Chá»‰ ngÃ y 27 thÃ¡ng 10 DÆ°Æ¡ng lá»‹ch','Tá»« ngÃ y 26 Ä‘áº¿n 28 thÃ¡ng 8 Ã‚m lá»‹ch','Chá»‰ ngÃ y 16 thÃ¡ng 9 Ã‚m lá»‹ch','Tá»« ngÃ y 1 Ä‘áº¿n 3 thÃ¡ng 1 DÆ°Æ¡ng lá»‹ch'],
        ans:1,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  B. Lá»… há»™i chÃ­nh Ká»³ yÃªn táº¡i ÄÃ¬nh tháº§n Nguyá»…n Trung Trá»±c á»Ÿ Ráº¡ch GiÃ¡, KiÃªn Giang Ä‘Æ°á»£c tá»• chá»©c trang trá»ng trong 3 ngÃ y tá»« 26 Ä‘áº¿n 28 thÃ¡ng 8 Ã‚m lá»‹ch háº±ng nÄƒm, vá»›i ngÃ y chÃ¡nh giá»— (ngÃ y hy sinh) lÃ  27/8 Ã‚m lá»‹ch.'
      },
      {
        q:'Nguyá»…n Trung Trá»±c tÃªn tháº­t lÃ  gÃ¬?',
        opts:['Nguyá»…n VÄƒn Lá»‹ch (cÃ²n gá»i lÃ  Nguyá»…n ChÆ¡n)','Nguyá»…n VÄƒn PhÃ¡t','Nguyá»…n Há»¯u Äá»‹nh','Nguyá»…n CÃ´ng Trá»©'],
        ans:0,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  A. TÃªn tháº­t cá»§a Ã´ng lÃ  Nguyá»…n VÄƒn Lá»‹ch, cÃ²n Ä‘Æ°á»£c gá»i lÃ  Nguyá»…n ChÆ¡n.'
      },
      {
        q:'CÃ¡c chiáº¿n cÃ´ng lá»«ng láº«y cá»§a Nguyá»…n Trung Trá»±c lÃ ?',
        opts:['Äá»‘t chÃ¡y tÃ u chiáº¿n cá»§a giáº·c trÃªn sÃ´ng Nháº­t Táº£o','ÄÃ¡nh chiáº¿m Ä‘á»“n Ráº¡ch GiÃ¡ - KiÃªn Giang','NghÄ©a quÃ¢n cá»§a Nguyá»…n Trung Trá»±c chá»‘ng cá»± quyáº¿t liá»‡t vÃ  giÃ nh chiáº¿n tháº¯ng táº¡i PhÃº Quá»‘c','Cáº£ A vÃ  B Ä‘á»u Ä‘Ãºng'],
        ans:3,
        explain:'ÄÃ¡p Ã¡n Ä‘Ãºng lÃ  D. Chiáº¿n cÃ´ng vang dá»™i cá»§a Nguyá»…n Trung Trá»±c lÃ  Äá»‘t chÃ¡y tÃ u chiáº¿n cá»§a giáº·c trÃªn sÃ´ng Nháº­t Táº£o vÃ  ÄÃ¡nh chiáº¿m Ä‘á»“n Ráº¡ch GiÃ¡ - KiÃªn Giang.'
      }
    ]
  }
};

/* Start quiz run: show one question at a time with explanation */
let currentQuiz = null;
let currentQIndex = 0;
function startQuiz(quizId, site){
  const qset = QUIZZES[quizId];
  if(!qset){ alert('Quiz chÆ°a cÃ³ ná»™i dung.'); return; }
  currentQuiz = {id:quizId, site:site, qset:qset};
  currentQIndex = 0;
  renderCurrentQuestion();
  document.getElementById('gameSubmit').style.display = 'none';
  document.getElementById('gameNext').style.display = 'inline-block';
  document.getElementById('gameTitle').innerText = qset.title;
  document.getElementById('gameNote').innerText = `Tráº£ lá»i tá»«ng cÃ¢u â€” báº¡n sáº½ nháº­n pháº£n há»“i ngay sau má»—i cÃ¢u.`;
  gameModal.show();
}
function renderCurrentQuestion(){
  const body = document.getElementById('gameBody');
  const qobj = currentQuiz.qset.items[currentQIndex];
  let html = `<div><strong>CÃ¢u ${currentQIndex+1} / ${currentQuiz.qset.items.length}</strong><p style="margin-top:8px"><em>${qobj.q}</em></p>`;
  html += `<div>`;
  qobj.opts.forEach((opt,i)=> html += `<div style="margin-bottom:6px"><label><input type="radio" name="opt" value="${i}"> ${opt}</label></div>`);
  html += `</div><div id="qFeedback" style="margin-top:10px"></div></div>`;
  body.innerHTML = html;
  document.getElementById('gameNext').innerText = currentQIndex+1 < currentQuiz.qset.items.length ? 'Tráº£ lá»i & Tiáº¿p' : 'Tráº£ lá»i & HoÃ n thÃ nh';
  document.getElementById('gameNext').onclick = handleAnswerAndNext;
}
function handleAnswerAndNext(){
  const sel = document.querySelector('input[name="opt"]:checked');
  if(!sel){ alert('Vui lÃ²ng chá»n 1 Ä‘Ã¡p Ã¡n'); return; }
  const chosen = Number(sel.value);
  const qobj = currentQuiz.qset.items[currentQIndex];
  const fb = document.getElementById('qFeedback');
  if(chosen === qobj.ans){
    fb.innerHTML = `<div class="correct">ÄÃ¡p Ã¡n Ä‘Ãºng âœ“</div><div class="explain">${qobj.explain}</div>`;
  } else {
    fb.innerHTML = `<div class="wrong">ÄÃ¡p Ã¡n sai âœ—</div><div class="explain">ÄÃ¡p Ã¡n Ä‘Ãºng: <strong>${qobj.opts[qobj.ans]}</strong><br>${qobj.explain}</div>`;
  }
  // brief pause then next or finish
  setTimeout(()=> {
    currentQIndex++;
    if(currentQIndex < currentQuiz.qset.items.length){
      renderCurrentQuestion();
    } else {
      // quiz finished: record and show final
      recordDone(currentQuiz.site.id, currentQuiz.id);
      alert('Báº¡n Ä‘Ã£ hoÃ n thÃ nh quiz: ' + currentQuiz.qset.title);
      gameModal.hide();
    }
  }, 700);
}

/* observe game (simple single-question observation) */
function startObserve(id, site){
  const body = document.getElementById('gameBody');
  document.getElementById('gameTitle').innerText = 'Quan sÃ¡t & Tráº£ lá»i';
  document.getElementById('gameNote').innerText = 'Xem áº£nh, chá»n Ä‘Ã¡p Ã¡n Ä‘Ãºng.';
  body.innerHTML = `<div><img src="${site.img}" style="width:100%;border-radius:8px"><p style="margin-top:8px">Trong áº£nh, váº­t dá»¥ng nÃ o thÆ°á»ng dÃ¹ng Ä‘á»ƒ giam giá»¯ tÃ¹ nhÃ¢n?</p>
    <div><label><input type="radio" name="obs" value="a"> MÃ¡y ghi Ã¢m</label></div>
    <div><label><input type="radio" name="obs" value="b"> Lá»“ng kÃ­nh</label></div>
    <div><label><input type="radio" name="obs" value="c"> Buá»“ng giam</label></div>
  </div>`;
  document.getElementById('gameSubmit').style.display='inline-block';
  document.getElementById('gameSubmit').onclick = ()=> {
    const sel = document.querySelector('input[name="obs"]:checked');
    if(!sel){ alert('Chá»n Ä‘Ã¡p Ã¡n'); return; }
    if(sel.value==='c'){ recordDone(site.id, id); alert('ÄÃºng! Báº¡n hoÃ n thÃ nh.'); gameModal.hide(); } else { alert('Sai â€” hÃ£y xem láº¡i áº£nh vÃ  thá»­ láº¡i.'); }
  };
  gameModal.show();
}

/* timeline simple */
function startTimeline(id, site){
  const body = document.getElementById('gameBody');
  document.getElementById('gameTitle').innerText = 'Sáº¯p xáº¿p má»‘c thá»i gian (demo)';
  document.getElementById('gameNote').innerText = 'KÃ©o tháº£ Ä‘á»ƒ sáº¯p xáº¿p thá»© tá»± (demo khÃ´ng cháº¥m chÃ­nh xÃ¡c).';
  const items = ['Sá»± kiá»‡n A (nÄƒm 18xx)','Sá»± kiá»‡n B (nÄƒm 19xx)','Sá»± kiá»‡n C (nÄƒm 20xx)'].sort(()=>Math.random()-0.5);
  body.innerHTML = `<ul id="tl" style="padding-left:18px">${items.map(it=>`<li draggable="true" style="padding:8px;border:1px solid #eee;margin-bottom:6px;background:white;border-radius:6px">${it}</li>`).join('')}</ul>`;
  // drag reorder simple
  let dragEl = null;
  setTimeout(()=> {
    document.querySelectorAll('#tl li').forEach(li=>{
      li.addEventListener('dragstart', e=> dragEl = li);
      li.addEventListener('dragover', e=> e.preventDefault());
      li.addEventListener('drop', e=> { e.preventDefault(); if(dragEl && dragEl !== li){ const parent = li.parentNode; parent.insertBefore(dragEl, li.nextSibling); } });
    });
  },50);
  document.getElementById('gameSubmit').style.display='inline-block';
  document.getElementById('gameSubmit').onclick = ()=> {
    recordDone(site.id, id);
    alert('HoÃ n thÃ nh (demo).');
    gameModal.hide();
  };
  gameModal.show();
}

/* startGameInstance wrapper called from picker */
function startGameInstance(gid, site){
  document.getElementById('gameBody').innerHTML = '';
  document.getElementById('gameSubmit').style.display='none';
  document.getElementById('gameNext').style.display='none';
  if(gid.startsWith('quiz_')) startQuiz(gid, site);
  else if(gid.startsWith('puzzle_')) startPuzzleGame(gid, site);
  else if(gid.startsWith('observe_')) startObserve(gid, site);
  else if(gid.startsWith('timeline_')) startTimeline(gid, site);
  else { alert('Game chÆ°a Ä‘Æ°á»£c há»— trá»£'); }
}

/* ---------- recordGame function used earlier ---------- */
function recordDone(siteId, gameId){ // reuse defined above
  const o = loadDone();
  if(!o[siteId]) o[siteId]=[];
  if(!o[siteId].includes(gameId)){ o[siteId].push(gameId); saveDone(o); checkAggregateBadges(); renderBadges(); }
}

/* ---------- initial UI state ---------- */
refreshAuthUI();
renderBadges();

/* ensure map resizes when switching pages */
window.addEventListener('resize', ()=> map.invalidateSize());
</script>
</body>
</html>
