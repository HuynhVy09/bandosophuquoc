<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc ‚Äî D·ª± √°n KHKT: T·ª± h√†o qu√™ h∆∞∆°ng</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
<style>
  :root{
    --accent:#7b0a0a; /* ƒë·ªè r∆∞·ª£u */
    --gold:#d4af37;   /* v√†ng kim */
    --bg:#0b0b0b;
    --card:#111214;
  }
  body{font-family: "Noto Sans", sans-serif; background:#f7f5f2; color:#111}
  .header{display:flex;align-items:center;justify-content:space-between;padding:18px 0}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:54px;height:54px;border-radius:8px;background:linear-gradient(135deg,var(--accent),#c33);display:flex;align-items:center;justify-content:center;color:white;font-weight:700;font-size:20px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
  .title{font-weight:700;color:var(--accent)}
  .sub{font-size:0.9rem;color:#666}
  .hero{background:linear-gradient(90deg, rgba(123,10,10,0.06), rgba(212,175,55,0.02));padding:18px;border-radius:12px;margin-bottom:16px}
  #map{height:64vh;border-radius:12px;box-shadow:0 8px 30px rgba(11,10,12,0.06);border:1px solid rgba(0,0,0,0.04)}
  .card-info{border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06)}
  .badge-img{width:56px;height:56px;border-radius:8px;object-fit:cover}
  .marker-emoji{font-size:20px;line-height:24px}
  .diatic-title{font-weight:700}
  .game-btn{background:linear-gradient(90deg,var(--accent),#b32);color:white}
  footer{padding:18px 0;color:#666}
  /* game styles */
  .quiz-item{margin-bottom:12px}
  .memory-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:8px}
  .card-tile{background:#fff;padding:6px;border-radius:8px;display:flex;align-items:center;justify-content:center;cursor:pointer;user-select:none}
  /* timeline */
  .timeline-list{list-style:none;padding-left:0}
  .timeline-list li{padding:8px 12px;border-radius:8px;margin-bottom:8px;background:#fff;cursor:grab}
</style>
</head>
<body>
<div class="container py-3">
  <div class="header mb-2">
    <div class="brand">
      <div class="logo">PQ</div>
      <div>
        <div class="title">B·∫£n ƒë·ªì s·ªë Ph√∫ Qu·ªëc</div>
        <div class="sub">D·ª± √°n KHKT ‚Äî Gi√°o d·ª•c l√≤ng t·ª± h√†o d√¢n t·ªôc (THPT An Th·ªõi)</div>
      </div>
    </div>
    <div>
      <button id="btn-register" class="btn btn-outline-dark me-2">ƒêƒÉng k√Ω</button>
      <button id="btn-login" class="btn btn-dark">ƒêƒÉng nh·∫≠p</button>
      <button id="btn-logout" class="btn btn-outline-secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
    </div>
  </div>

  <div class="hero mb-3 d-flex align-items-center justify-content-between">
    <div>
      <h3 style="margin:0;color:var(--accent)">Kh√°m ph√° di t√≠ch ‚Äî H·ªçc l·ªãch s·ª≠ qua t∆∞∆°ng t√°c</h3>
      <div class="sub">Click v√†o ƒëi·ªÉm tr√™n b·∫£n ƒë·ªì ƒë·ªÉ xem th√¥ng tin, ch∆°i mini-game v√† nh·∫≠n huy hi·ªáu.</div>
    </div>
    <div class="text-end">
      <a href="#map" class="btn btn-lg game-btn">Kh√°m ph√° b·∫£n ƒë·ªì</a>
    </div>
  </div>

  <div id="map"></div>

  <div class="card p-3 mt-3 card-info">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <div style="font-weight:700">Huy hi·ªáu c·ªßa b·∫°n</div>
        <div class="sub">L∆∞u t·∫°m trong t√†i kho·∫£n (demo)</div>
      </div>
      <div id="badge-area" class="d-flex gap-2"></div>
    </div>
  </div>

  <footer class="text-center mt-3">¬© D·ª± √°n KHKT ‚Äî THPT An Th·ªõi ‚Äî Demo GitHub Pages (mi·ªÖn ph√≠)</footer>
</div>

<!-- Modal ch√≠nh cho di t√≠ch -->
<div class="modal fade" id="diModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:linear-gradient(90deg,var(--accent),#b32);color:white">
        <h5 class="modal-title" id="diModalTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="diModalBody"></div>
      <div class="modal-footer">
        <div class="me-auto">
          <small class="text-muted">To·∫° ƒë·ªô: <span id="diCoords"></span></small>
        </div>
        <button id="playGamesBtn" class="btn game-btn" style="display:none">Ch∆°i mini-game</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal: game container -->
<div class="modal fade" id="gameModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background:#111;color:var(--gold)">
        <h5 class="modal-title" id="gameTitle"></h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="gameBody"></div>
      <div class="modal-footer">
        <div class="me-auto"><small id="gameHint" class="text-muted"></small></div>
        <button id="gameSubmit" class="btn btn-dark">Ho√†n th√†nh</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">Tho√°t</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal ƒëƒÉng k√Ω / ƒëƒÉng nh·∫≠p -->
<div class="modal fade" id="authModal" tabindex="-1">
  <div class="modal-dialog modal-sm modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="authTitle">ƒêƒÉng k√Ω</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="authAlert" class="alert alert-danger d-none"></div>
        <div class="mb-2">
          <input id="inName" class="form-control" placeholder="T√™n hi·ªÉn th·ªã">
        </div>
        <div class="mb-2">
          <input id="inEmail" class="form-control" placeholder="Gmail">
        </div>
        <div class="mb-2">
          <input id="inPass" type="password" class="form-control" placeholder="M·∫≠t kh·∫©u">
        </div>
        <div class="form-text">D·ªØ li·ªáu demo l∆∞u c·ª•c b·ªô (local). Khi deploy th·∫≠t, c√≥ th·ªÉ chuy·ªÉn sang Firebase mi·ªÖn ph√≠.</div>
      </div>
      <div class="modal-footer">
        <button id="authSubmit" class="btn btn-dark">X√°c nh·∫≠n</button>
        <button class="btn btn-outline-secondary" data-bs-dismiss="modal">H·ªßy</button>
      </div>
    </div>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

<script>
/* ========== D·ªÆ LI·ªÜU DI T√çCH (c√≥ th·ªÉ hi·ªáu ch·ªânh to·∫° ƒë·ªô b·∫±ng Google Maps n·∫øu c·∫ßn) ========== */
const diTich = [
  /* ƒêi·ªÉm ch√≠nh 1: Nh√† t√π Ph√∫ Qu·ªëc (3 game) */
  {
    id: 'nha-tu',
    name: 'Nh√† t√π Ph√∫ Qu·ªëc',
    lat: 10.2228, lng: 103.9463, // <--- b·∫°n n√™n verify ch√≠nh x√°c; ƒë√¢y l√† to·∫° ƒë·ªô tham kh·∫£o
    desc: 'Nh√† t√π Ph√∫ Qu·ªëc ‚Äî di t√≠ch ch·ª©ng t√≠ch chi·∫øn tranh, n∆°i giam gi·ªØ nhi·ªÅu chi·∫øn sƒ© ƒë·∫•u tranh.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/3/3d/Nha_Tu_Phu_Quoc.jpg',
    games: ['quiz_nhatu','match_nhatu','find_nhatu']
  },
  /* ƒêi·ªÉm ch√≠nh 2: ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c (3 game) */
  {
    id: 'dinh-ntt',
    name: 'ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c',
    lat: 10.2764, lng: 103.9732,
    desc: 'ƒê√¨nh th·ªù Nguy·ªÖn Trung Tr·ª±c ‚Äî bi·ªÉu t∆∞·ª£ng tinh th·∫ßn b·∫•t khu·∫•t ch·ªëng ngo·∫°i x√¢m.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/5/5f/Nguyen_Trung_Truc_temple.jpg',
    games: ['memory_trungtruc','quiz_trungtruc','timeline_trungtruc']
  },
  /* ƒêi·ªÉm ph·ª•: Nh√† th√πng n∆∞·ªõc m·∫Øm */
  {
    id: 'nha-thung',
    name: 'Nh√† th√πng n∆∞·ªõc m·∫Øm Ph√∫ Qu·ªëc',
    lat: 10.3156, lng: 103.9935,
    desc: 'Nh√† th√πng n∆∞·ªõc m·∫Øm truy·ªÅn th·ªëng ‚Äî tinh hoa ngh·ªÅ bi·ªÉn Ph√∫ Qu·ªëc.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/6/62/Phu_Quoc_fish_sauce_barrels.jpg',
    games: []
  },
  /* Dinh C·∫≠u */
  {
    id: 'dinh-cau',
    name: 'Dinh C·∫≠u',
    lat: 10.2817, lng: 103.9980,
    desc: 'Dinh C·∫≠u ‚Äî t√≠n ng∆∞·ª°ng, bi·ªÉu t∆∞·ª£ng c·ªßa ng∆∞ d√¢n ƒë·ªãa ph∆∞∆°ng.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/2/2d/DinhCauPhuQuoc.jpg',
    games: []
  },
  /* L√†ng ch√†i H√†m Ninh */
  {
    id: 'ham-ninh',
    name: 'L√†ng ch√†i H√†m Ninh',
    lat: 10.2865, lng: 103.9957,
    desc: 'L√†ng ch√†i truy·ªÅn th·ªëng, n·ªïi ti·∫øng h·∫£i s·∫£n t∆∞∆°i ngon.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/9/9b/Ham_Ninh_fishing_village.jpg',
    games: []
  },
  /* B·∫£o t√†ng C·ªôi Ngu·ªìn */
  {
    id: 'baotang',
    name: 'B·∫£o t√†ng C·ªôi Ngu·ªìn',
    lat: 10.2773, lng: 103.9730,
    desc: 'B·∫£o t√†ng tr∆∞ng b√†y l·ªãch s·ª≠ ‚Äì vƒÉn ho√° ƒë·ªãa ph∆∞∆°ng.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/0/0e/Museum.jpg',
    games: []
  },
  /* Ch√πa H·ªô Qu·ªëc */
  {
    id: 'chua',
    name: 'Ch√πa H·ªô Qu·ªëc',
    lat: 10.3148, lng: 103.9702,
    desc: 'Ch√πa H·ªô Qu·ªëc (Thi·ªÅn vi·ªán Tr√∫c L√¢m H·ªô Qu·ªëc) ‚Äî ki·∫øn tr√∫c t√¢m linh l·ªõn.',
    img: 'https://upload.wikimedia.org/wikipedia/commons/0/0f/Chua.jpg',
    games: []
  }
];

/* ========== Helpers: localStorage user & badges (demo) ========== */
const STORAGE_USER = 'pq_user_demo';
const STORAGE_BADGES = 'pq_badges_demo';

function saveUser(obj){ localStorage.setItem(STORAGE_USER, JSON.stringify(obj)) }
function loadUser(){ return JSON.parse(localStorage.getItem(STORAGE_USER)||'null') }
function saveBadges(arr){ localStorage.setItem(STORAGE_BADGES, JSON.stringify(arr)) }
function loadBadges(){ return JSON.parse(localStorage.getItem(STORAGE_BADGES)||'[]') }

/* ========== Init Map ========== */
const map = L.map('map').setView([10.28,103.98], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'¬© OpenStreetMap'}).addTo(map);

/* Create markers with illustrative icons (minh ho·∫° di t√≠ch) */
function createMarkerIcon(emoji){
  return L.divIcon({className:'custom-icon', html:`<div style="background:linear-gradient(180deg,#fff,#f1f1f1);padding:6px;border-radius:8px;border:2px solid #fff;box-shadow:0 6px 12px rgba(0,0,0,0.12)"><span class="marker-emoji">${emoji}</span></div>`, iconSize:[36,36], iconAnchor:[18,36]});
}

/* map markers */
diTich.forEach(d=>{
  const emoji = d.games.length ? 'üèõÔ∏è' : 'üìç';
  const m = L.marker([d.lat,d.lng], {icon: createMarkerIcon(emoji)}).addTo(map);
  m.on('click', ()=> openDiModal(d));
});

/* modal instances */
const diModal = new bootstrap.Modal(document.getElementById('diModal'));
const gameModal = new bootstrap.Modal(document.getElementById('gameModal'));
const authModal = new bootstrap.Modal(document.getElementById('authModal'));

/* render badge area */
function renderBadges(){
  const wrap = document.getElementById('badge-area');
  wrap.innerHTML = '';
  const arr = loadBadges();
  arr.forEach(b=>{
    const el = document.createElement('div');
    el.innerHTML = `<div style="text-align:center"><img src="${b.icon}" class="badge-img"><div style="font-size:12px">${b.name}</div></div>`;
    wrap.appendChild(el);
  });
}

/* open di t√≠ch modal */
function openDiModal(d){
  document.getElementById('diModalTitle').innerText = d.name;
  const html = `
    <div class="row">
      <div class="col-md-6">
        <img src="${d.img}" alt="${d.name}" style="width:100%;border-radius:8px;object-fit:cover;max-height:320px">
      </div>
      <div class="col-md-6">
        <h5 class="diatic-title">${d.name}</h5>
        <p class="text-muted">${d.desc}</p>
        <p><strong>ƒê·ªãa ch·ªâ (to·∫° ƒë·ªô):</strong> ${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}</p>
        ${d.games.length ? `<div><strong>Mini-game:</strong><ul>${d.games.map(g=>`<li>${gameLabel(g)}</li>`).join('')}</ul></div>` : '<div class="text-muted">Kh√¥ng c√≥ mini-game ·ªü ƒëi·ªÉm n√†y</div>'}
      </div>
    </div>
  `;
  document.getElementById('diModalBody').innerHTML = html;
  document.getElementById('diCoords').innerText = `${d.lat.toFixed(6)}, ${d.lng.toFixed(6)}`;
  const btn = document.getElementById('playGamesBtn');
  if(d.games.length){
    btn.style.display = 'inline-block';
    btn.onclick = ()=> { diModal.hide(); openGameSelector(d) };
  } else {
    btn.style.display = 'none';
    btn.onclick = null;
  }
  diModal.show();
}

/* game label helper */
function gameLabel(id){
  const map = {
    quiz_nhatu:'Quiz l·ªãch s·ª≠ (5 c√¢u)',
    match_nhatu:'Gh√©p ·∫£nh - v·ªã tr√≠',
    find_nhatu:'T√¨m chi ti·∫øt trong ·∫£nh',
    memory_trungtruc:'Memory: gh√©p s·ª± ki·ªán',
    quiz_trungtruc:'Quiz trung tr·ª•c (5 c√¢u)',
    timeline_trungtruc:'S·∫Øp x·∫øp m·ªëc th·ªùi gian'
  };
  return map[id] || id;
}

/* open a simple selector for games at that di t√≠ch */
function openGameSelector(d){
  // build selector UI
  const html = `<div><p class="mb-2">Ch·ªçn mini-game:</p><div class="d-flex gap-2 flex-wrap">` +
    d.games.map(g=>`<button class="btn btn-outline-dark game-choice" data-game="${g}">${gameLabel(g)}</button>`).join('') +
    `</div></div>`;
  // show in game modal
  document.getElementById('gameTitle').innerText = `Mini-game ‚Äî ${d.name}`;
  document.getElementById('gameBody').innerHTML = html;
  document.getElementById('gameSubmit').style.display='none';
  document.getElementById('gameHint').innerText = 'Ch·ªçn 1 mini-game ƒë·ªÉ b·∫Øt ƒë·∫ßu';
  gameModal.show();

  // add listeners
  document.querySelectorAll('.game-choice').forEach(btn=>{
    btn.addEventListener('click', ()=> {
      const g = btn.getAttribute('data-game');
      startGame(g, d);
    });
  });
}

/* awarding badge util (with icons) */
function awardBadgeInternal(id,name){
  const badges = loadBadges();
  if(badges.find(b=>b.id===id)) return false;
  const icon = (id==='badge1')? 'https://via.placeholder.com/64/C33/fff?text=A' : (id==='badge2')? 'https://via.placeholder.com/64/7a3/fff?text=B' : 'https://via.placeholder.com/64/aa6/fff?text=C';
  badges.push({id,name,icon});
  saveBadges(badges);
  renderBadges();
  confetti({particleCount:80,spread:60,origin:{y:0.4}});
  alert('B·∫°n nh·∫≠n huy hi·ªáu: ' + name);
  return true;
}

/* check conditions and award main badges:
 - badge1: ho√†n th√†nh 3 game t·∫°i Nh√† t√π
 - badge2: ho√†n th√†nh 3 game t·∫°i ƒê√¨nh NTT
 - badge3: m·ªü t·∫•t c·∫£ 7 ƒëi·ªÉm (visit)
*/
function checkAllBadges(){
  const badges = loadBadges();
  const user = loadUser();
  // track completed games per site in storage (demo)
  const done = JSON.parse(localStorage.getItem('pq_done_games')||'{}');
  // badge1
  if(done['nha-tu'] && done['nha-tu'].length >= 3) awardBadgeInternal('badge1','Anh h√πng b·∫£o v·ªá bi·ªÉn ƒë·∫£o');
  if(done['dinh-ntt'] && done['dinh-ntt'].length >= 3) awardBadgeInternal('badge2','Ch√≠nh kh√≠ Nguy·ªÖn Trung Tr·ª±c');
  // visits:
  const visited = JSON.parse(localStorage.getItem('pq_visited')||'[]');
  if(visited.length >= diTich.length) awardBadgeInternal('badge3','Nh√† kh√°m ph√° Ph√∫ Qu·ªëc');
}

/* mark visit to di t√≠ch */
function markVisited(id){
  let arr = JSON.parse(localStorage.getItem('pq_visited')||'[]');
  if(!arr.includes(id)){ arr.push(id); localStorage.setItem('pq_visited', JSON.stringify(arr)); }
  checkAllBadges();
}

/* record game done */
function recordGame(siteId, gameId){
  const o = JSON.parse(localStorage.getItem('pq_done_games')||'{}');
  if(!o[siteId]) o[siteId]=[];
  if(!o[siteId].includes(gameId)){ o[siteId].push(gameId); localStorage.setItem('pq_done_games', JSON.stringify(o)); }
  checkAllBadges();
}

/* ========== GAME IMPLEMENTATIONS (simple, accessible) ========== */

/* START a game by id for a di t√≠ch */
function startGame(gid, di){
  // wrapper not used (we use startGame called via openGameSelector)
}

/* functions for each mini-game: render UI in gameBody */
function startGameInstance(g, d){
  const body = document.getElementById('gameBody');
  const title = document.getElementById('gameTitle');
  document.getElementById('gameSubmit').style.display='inline-block';
  document.getElementById('gameSubmit').onclick = ()=> submitGame(g,d);
  if(g==='quiz_nhatu'){
    title.innerText = 'Quiz Nh√† t√π Ph√∫ Qu·ªëc (5 c√¢u)';
    const qs = [
      {q:'Nh√† t√π Ph√∫ Qu·ªëc l√† di t√≠ch li√™n quan ƒë·∫øn:', a:['Ho·∫°t ƒë·ªông vƒÉn h√≥a','Chi·∫øn tranh & t√π ch√≠nh tr·ªã','Du l·ªãch bi·ªÉn'], correct:1},
      {q:'M·ªôt gi√° tr·ªã c·∫ßn h·ªçc t·ª´ Nh√† t√π Ph√∫ Qu·ªëc l√†:', a:['Tinh th·∫ßn ki√™n c∆∞·ªùng','Gi·∫£i tr√≠','Th·ªùi trang'], correct:0},
      {q:'Nh√† t√π n√†y n·∫±m tr√™n ƒë·∫£o n√†o?', a:['Ph√∫ Qu·ªëc','C√¥n ƒê·∫£o','Ph√∫ Y√™n'], correct:0},
      {q:'Di t√≠ch gi√∫p h·ªçc sinh nh·∫≠n ra:', a:['√ù nghƒ©a h√≤a b√¨nh','C√°ch l√†m m·∫Øm','C√°ch tr·ªìng ti√™u'], correct:0},
      {q:'Khi ho√†n th√†nh quiz n√†y, b·∫°n s·∫Ω:', a:['C√≥ ki·∫øn th·ª©c m·ªõi','Nh·∫≠n huy hi·ªáu','C·∫£ hai'], correct:2}
    ];
    let html = qs.map((it,idx)=>`<div class="quiz-item"><div><strong>${idx+1}. ${it.q}</strong></div>${it.a.map((opt,i)=>`<div><label><input type="radio" name="q${idx}" value="${i}"> ${opt}</label></div>`).join('')}</div>`).join('');
    body.innerHTML = html;
    document.getElementById('gameHint').innerText = 'Ch·ªçn ƒë√°p √°n r·ªìi b·∫•m Ho√†n th√†nh';
  } else if(g==='match_nhatu'){
    title.innerText = 'Gh√©p ·∫£nh - nh·∫≠n di·ªán (Nh√† t√π)';
    // simple drag-drop: left images, right slots with labels
    const items = [
      {img:'https://upload.wikimedia.org/wikipedia/commons/3/3d/Nha_Tu_Phu_Quoc.jpg', label:'C·ªïng ch√≠nh'},
      {img:'https://upload.wikimedia.org/wikipedia/commons/1/1a/Cell.jpg', label:'Bu·ªìng giam'},
      {img:'https://upload.wikimedia.org/wikipedia/commons/4/4a/Prison_yard.jpg', label:'S√¢n giam'}
    ];
    // shuffle right labels
    const labels = items.map(it=>it.label).sort(()=>Math.random()-0.5);
    let left = items.map((it,idx)=>`<div class="card-tile" draggable="true" data-id="${idx}"><img src="${it.img}" style="width:100%;height:80px;object-fit:cover;border-radius:6px"></div>`).join('');
    let right = labels.map((lab,idx)=>`<div class="card-tile drop-slot" data-label="${lab}" style="height:90px">${lab}</div>`).join('');
    body.innerHTML = `<div class="row"><div class="col-6">${left}</div><div class="col-6">${right}</div></div>`;
    // add drag-drop listeners
    setTimeout(()=> {
      document.querySelectorAll('.card-tile[draggable]').forEach(el=>{
        el.addEventListener('dragstart', e=> { e.dataTransfer.setData('text/plain', el.getAttribute('data-id')); });
      });
      document.querySelectorAll('.drop-slot').forEach(slot=>{
        slot.addEventListener('dragover', e=> e.preventDefault());
        slot.addEventListener('drop', e=>{
          const id = e.dataTransfer.getData('text/plain');
          const tile = document.querySelector(`.card-tile[draggable][data-id="${id}"]`);
          if(tile){
            slot.innerHTML = '';
            slot.appendChild(tile);
          }
        });
      });
    },200);
    document.getElementById('gameHint').innerText='K√©o ·∫£nh v√†o nh√£n ph√π h·ª£p r·ªìi b·∫•m Ho√†n th√†nh';
  } else if(g==='find_nhatu'){
    title.innerText = 'T√¨m chi ti·∫øt - quan s√°t h√¨nh';
    body.innerHTML = `<div><img src="https://upload.wikimedia.org/wikipedia/commons/3/3d/Nha_Tu_Phu_Quoc.jpg" style="width:100%;border-radius:8px"><div class="mt-2"><p>Trong ·∫£nh, v·∫≠t d·ª•ng n√†o th∆∞·ªùng d√πng ƒë·ªÉ giam gi·ªØ t√π nh√¢n?</p><div><label><input type="radio" name="f" value="a"> M√°y ghi √¢m</label></div><div><label><input type="radio" name="f" value="b"> L·ªìng k√≠nh</label></div><div><label><input type="radio" name="f" value="c"> Bu·ªìng giam</label></div></div></div>`;
    document.getElementById('gameHint').innerText='Quan s√°t ·∫£nh v√† ch·ªçn c√¢u ƒë√∫ng';
  } else if(g==='memory_trungtruc'){
    title.innerText = 'Memory - gh√©p s·ª± ki·ªán (ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c)';
    // simple memory with 6 cards
    const pairs = [
      {k:'Nguy·ªÖn Trung Tr·ª±c', v:'L√£nh t·ª• nghƒ©a qu√¢n'},
      {k:'S·ª± ki·ªán A', v:'Chi·∫øn th·∫Øng B'},
      {k:'L·ªÖ h·ªôi', v:'Th√°ng 8 √¢m l·ªãch'}
    ];
    const cards = pairs.flatMap((p,i)=>[{type:'k',text:p.k},{type:'v',text:p.v}]).sort(()=>Math.random()-0.5);
    let html = `<div class="memory-grid">` + cards.map((c,idx)=>`<div class="card-tile mem" data-idx="${idx}" data-text="${c.text}">${c.text}</div>`).join('') + `</div>`;
    body.innerHTML = html;
    // memory logic
    setTimeout(()=> {
      let first=null;
      document.querySelectorAll('.mem').forEach(el=>{
        el.addEventListener('click', ()=>{
          el.style.background='#ffd';
          if(!first){ first=el; }
          else {
            if(first.getAttribute('data-text') === el.getAttribute('data-text')){
              // same card clicked twice -> keep
            } else {
              // reveal then hide
              setTimeout(()=> { first.style.background=''; el.style.background=''; first=null; },700);
            }
          }
        });
      });
    },100);
    document.getElementById('gameHint').innerText='Click l·∫≠t c√°c th·∫ª ƒë·ªÉ gh√©p ƒë√¥i (demo ƒë∆°n gi·∫£n)';
  } else if(g==='quiz_trungtruc'){
    title.innerText = 'Quiz ƒê√¨nh Nguy·ªÖn Trung Tr·ª±c (5 c√¢u)';
    const qs = [
      {q:'Nguy·ªÖn Trung Tr·ª±c l√† ai?', a:['Nh√† th∆°','L√£nh t·ª• nghƒ©a qu√¢n','Ngh·ªá sƒ©'], correct:1},
      {q:'L·ªÖ h·ªôi ƒë√¨nh th∆∞·ªùng t·ªï ch·ª©c v√†o th√°ng n√†o?', a:['Th√°ng 1','Th√°ng 8 √¢m l·ªãch','Th√°ng 12'], correct:1},
      {q:'Gi√° tr·ªã c·∫ßn h·ªçc t·ª´ nh√¢n v·∫≠t n√†y l√†:', a:['Tinh th·∫ßn ƒë·ªôc l·∫≠p','N√≥i nhi·ªÅu','ƒÇn u·ªëng'], correct:0},
      {q:'ƒê√¨nh th∆∞·ªùng l√† n∆°i ƒë·ªÉ:', a:['C√∫ng l·ªÖ & sinh ho·∫°t c·ªông ƒë·ªìng','Xu·∫•t kh·∫©u h√†ng h√≥a','Tr·ªìng ti√™u'], correct:0},
      {q:'Ho√†n th√†nh quiz n√†y gi√∫p:', a:['Nh·∫≠n huy hi·ªáu','Bi·∫øt n·∫•u ƒÉn','Xem phim'], correct:0}
    ];
    let html = qs.map((it,idx)=>`<div class="quiz-item"><div><strong>${idx+1}. ${it.q}</strong></div>${it.a.map((opt,i)=>`<div><label><input type="radio" name="qT${idx}" value="${i}"> ${opt}</label></div>`).join('')}</div>`).join('');
    body.innerHTML = html;
    document.getElementById('gameHint').innerText='Ch·ªçn ƒë√°p √°n v√† b·∫•m Ho√†n th√†nh';
  } else if(g==='timeline_trungtruc'){
    title.innerText = 'S·∫Øp x·∫øp m·ªëc th·ªùi gian (ƒê√¨nh)';
    const items = ['S·ª± ki·ªán A (nƒÉm 18xx)','S·ª± ki·ªán B (nƒÉm 19xx)','S·ª± ki·ªán C (nƒÉm 20xx)'];
    const html = `<ul class="timeline-list">${items.sort(()=>Math.random()-0.5).map(it=>`<li draggable="true">${it}</li>`).join('')}</ul>`;
    body.innerHTML = html;
    // simple drag reorder (not persisted)
    let dragEl = null;
    setTimeout(()=> {
      document.querySelectorAll('.timeline-list li').forEach(li=>{
        li.addEventListener('dragstart', e=> dragEl = li);
        li.addEventListener('dragover', e=> e.preventDefault());
        li.addEventListener('drop', e=> {
          e.preventDefault();
          if(dragEl && dragEl !== li){
            const parent = li.parentNode;
            parent.insertBefore(dragEl, li.nextSibling);
          }
        });
      });
    },100);
    document.getElementById('gameHint').innerText='K√©o th·∫£ ƒë·ªÉ s·∫Øp x·∫øp th·ª© t·ª± h·ª£p l√Ω';
  } else {
    body.innerHTML = '<div>Mini-game demo ch∆∞a ƒë∆∞·ª£c h·ªó tr·ª£.</div>';
  }
}

/* submitGame: evaluate simple games */
function submitGame(g,d){
  const body = document.getElementById('gameBody');
  let success=false;
  if(g==='quiz_nhatu'){
    const qs = body.querySelectorAll('.quiz-item');
    let score=0;
    const answers = [1,0,0,0,2]; // as defined earlier
    qs.forEach((it,idx)=> {
      const sel = it.querySelector('input[type=radio]:checked');
      if(sel && Number(sel.value) === answers[idx]) score++;
    });
    if(score >= 4) success = true;
    alert('B·∫°n ƒë∆∞·ª£c ' + score + '/5 ƒëi·ªÉm');
  } else if(g==='match_nhatu'){
    // check each slot containing tile with matching label - simple check: presence of all tiles in slots
    const slots = document.querySelectorAll('.drop-slot');
    let good = 0;
    slots.forEach(slot=>{
      const child = slot.querySelector('.card-tile[draggable]');
      if(child){
        good++;
      }
    });
    if(good === slots.length) success = true;
    alert(`B·∫°n ƒë√£ ƒë·∫∑t ${good}/${slots.length} ·∫£nh v√†o nh√£n`);
  } else if(g==='find_nhatu'){
    const sel = body.querySelector('input[name=f]:checked');
    if(sel && sel.value === 'c') success = true;
    alert(sel ? 'B·∫°n ch·ªçn: ' + sel.parentNode.innerText : 'B·∫°n ch∆∞a ch·ªçn ƒë√°p √°n');
  } else if(g==='memory_trungtruc'){
    // demo: assume success (since no real logic)
    success = true;
    alert('Memory: (demo) xem nh∆∞ b·∫°n ho√†n th√†nh');
  } else if(g==='quiz_trungtruc'){
    const qs = body.querySelectorAll('.quiz-item');
    let score=0;
    const answers = [1,1,0,0,0];
    qs.forEach((it,idx)=> {
      const sel = it.querySelector('input[type=radio]:checked');
      if(sel && Number(sel.value) === answers[idx]) score++;
    });
    if(score >= 4) success = true;
    alert('B·∫°n ƒë∆∞·ª£c ' + score + '/5 ƒëi·ªÉm');
  } else if(g==='timeline_trungtruc'){
    // rudimentary: accept as success
    success = true;
    alert('S·∫Øp x·∫øp: (demo) ch·∫•m th√†nh c√¥ng');
  } else {
    alert('Game ch∆∞a x·ª≠ l√Ω');
  }

  if(success){
    // record game done and mark visited
    recordGame(d.id, g);
    markVisited(d.id);
    // award per-site small badge? keep global badges as final awards
    // show celebration
    confetti({particleCount:60,spread:50,origin:{y:0.5}});
    // close game modal
    gameModal.hide();
  }
}

/* event: when user clicks a choice in selector -> start appropriate game */
function startGame(g,d){
  // populate game UI
  startGameInstance(g,d);
  // show modal
  gameModal.show();
}

/* ========== Auth (simple local demo) ========== */
document.getElementById('btn-register').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng k√Ω';
  document.getElementById('authSubmit').onclick = authRegister;
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-login').addEventListener('click', ()=> {
  document.getElementById('authTitle').innerText = 'ƒêƒÉng nh·∫≠p';
  document.getElementById('authSubmit').onclick = authLogin;
  document.getElementById('authAlert').classList.add('d-none');
  authModal.show();
});
document.getElementById('btn-logout').addEventListener('click', ()=> {
  localStorage.removeItem(STORAGE_USER);
  document.getElementById('btn-login').style.display='';
  document.getElementById('btn-register').style.display='';
  document.getElementById('btn-logout').style.display='none';
  alert('B·∫°n ƒë√£ ƒëƒÉng xu·∫•t (demo).');
});

function authRegister(){
  const name = document.getElementById('inName').value.trim();
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  if(!name || !email || !pass){ showAuthError('ƒêi·ªÅn ƒë·ªß t√™n, email, m·∫≠t kh·∫©u'); return; }
  // simple validation & store
  const u = {name,email,pass};
  saveUser(u);
  alert('ƒêƒÉng k√Ω th√†nh c√¥ng (demo). Vui l√≤ng ƒëƒÉng nh·∫≠p.');
  authModal.hide();
}
function authLogin(){
  const email = document.getElementById('inEmail').value.trim();
  const pass = document.getElementById('inPass').value;
  const u = loadUser();
  if(!u || u.email !== email || u.pass !== pass){ showAuthError('Email ho·∫∑c m·∫≠t kh·∫©u kh√¥ng ƒë√∫ng (demo)'); return; }
  // login success
  document.getElementById('btn-login').style.display='none';
  document.getElementById('btn-register').style.display='none';
  document.getElementById('btn-logout').style.display='inline-block';
  authModal.hide();
  alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng. Ch√†o ' + u.name);
  renderBadges();
}
function showAuthError(msg){ const a = document.getElementById('authAlert'); a.innerText = msg; a.classList.remove('d-none'); }

/* initial render */
renderBadges();

/* Mark visit when user clicks marker: we do that in openDiModal already when they open modal? We'll mark visited on opening */
(function attachVisitOnOpen(){
  // modified openDiModal earlier to mark visited
  // We'll mark when modal is shown
  const modalEl = document.getElementById('diModal');
  modalEl.addEventListener('shown.bs.modal', function (event) {
    const title = document.getElementById('diModalTitle').innerText;
    const d = diTich.find(x=>x.name === title);
    if(d) markVisited(d.id);
  });
})();

</script>
</body>
</html>
